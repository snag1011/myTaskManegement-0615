<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æœ€çµ‚å®Œæˆç‰ˆ Ver.3.0ã€‘ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆæ¥­å‹™ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 1600px; margin: 0 auto; }
        .auth-bar { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-bottom: 20px; }
        .auth-bar button { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; color: white; }
        #login-btn { background-color: #4285F4; } #logout-btn { background-color: #d9534f; }
        .main-content { display: none; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; }
        h2 { font-size: 1.3em; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-top: 15px; color: #34495e; }
        h3 { font-size: 1.0em; font-weight: 600; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid; }
        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        .planning-column, .execution-column { display: flex; flex-direction: column; gap: 25px; }
        .panel { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .date-selector-panel { text-align: center; margin-bottom: 20px; }
        #main-date-picker { padding: 10px; font-size: 1.2em; border: 2px solid #3498db; border-radius: 8px; }
        .input-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .input-form input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
        .input-form input[type="text"] { flex-grow: 1; }
        .input-form input[type="number"] { width: 70px; text-align: center; }
        .input-form button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; transition: background-color 0.3s; }
        #add-plan-btn { background-color: #3498db; }
        #add-urgent-btn { background-color: #e74c3c; }
        .task-list { list-style-type: none; padding: 10px; min-height: 60px; border: 2px dashed #e0e0e0; border-radius: 8px; transition: background-color 0.2s; }
        .task-list.drag-over { background-color: #eaf5ff; }
        .task-item { background-color: #ecf0f1; padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; cursor: grab; border-left: 5px solid #3498db; user-select: none; }
        .task-item.dragging { opacity: 0.4; }
        .task-item .task-content { flex-grow: 1; }
        .task-item .task-text { font-weight: 500; word-break: break-all; }
        .task-item .task-details { font-size: 0.85em; color: #7f8c8d; margin-left: 10px; white-space: nowrap; }
        .task-item.urgent { border-left-color: #e74c3c; background-color: #fdeded; }
        .delete-plan-btn { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 1.5em; font-weight: bold; opacity: 0; transition: opacity 0.2s; padding: 0 8px; line-height: 1; }
        .task-item:hover .delete-plan-btn { opacity: 0.6; }
        .delete-plan-btn:hover { opacity: 1; }
        .execution-top { display: flex; align-items: center; justify-content: space-between; gap: 20px; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #timer-clock { font-size: 2.5em; font-weight: bold; letter-spacing: 2px; }
        #current-task-display { text-align: left; } #current-task-display p { margin: 0; font-size: 1.1em; }
        .priority-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .priority-box { padding: 15px; border-radius: 8px; }
        #box-a { background: #fff5f5; border: 1px solid #e57373; } #box-a h3 { color: #c62828; border-color: #ef9a9a; }
        #box-b { background: #f1f8e9; border: 1px solid #aed581; } #box-b h3 { color: #558b2f; border-color: #c5e1a5; }
        #box-c { background: #fffde7; border: 1px solid #ffd54f; } #box-c h3 { color: #f9a825; border-color: #ffe082; }
        #box-d { background: #f5f5f5; border: 1px solid #e0e0e0; } #box-d h3 { color: #616161; border-color: #eee; }
        .execution-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .execution-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .daily-input { width: 10 color: #2c3e50; text-align: center; margin-bottom: 10px; }
        h2 { font-size: 1.3em; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-top: 15px; color: #34495e; }
        h3 { font-size: 1.0em; font-weight: 600; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid; }
        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        .planning-column, .execution-column { display: flex; flex-direction: column; gap: 25px; }
        .panel { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .date-selector-panel { text-align: center; margin-bottom: 20px; }
        #main-date-picker { padding: 10px; font-size: 1.2em; border: 2px solid #3498db; border-radius: 8px; }
        .input-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .input-form input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
        .input-form input[type="text"] { flex-grow: 1; }
        .input-form input[type="number"] { width: 70px; text-align: center; }
        .input-form button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; transition: background-color 0.3s; }
        #add-plan-btn { background-color: #3498db; }
        #add-urgent-btn { background-color: #e74c3c; }
        .task-list { list-style-type: none; padding: 10px; min-height: 60px; border: 2px dashed #e0e0e0; border-radius: 8px; transition: background-color 0.2s; }
        .task-list.drag-over { background-color: #eaf5ff; }
        .task-item { background-color: #ecf0f1; padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; cursor: grab; border-left: 5px solid #3498db; user-select: none; }
        .task-item.dragging { opacity: 0.4; }
        .task-item .task-content { flex-grow: 1; }
        .task-item .task-text { font-weight: 500; word-break: break-all; }
        .task-item .task-details { font-size: 0.85em; color: #7f8c8d; margin-left: 10px; white-space: nowrap; }
        .task-item.urgent { border-left-color: #e74c3c; background-color: #fdeded; }
        .delete-plan-btn { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 1.5em; font-weight: bold; opacity: 0; transition: opacity 0.2s; padding: 0 8px; line-height: 1; }
        .task-item:hover .delete-plan-btn { opacity: 0.6; }
        .delete-plan-btn:hover { opacity: 1; }
        .execution-top { display: flex; align-items: center; justify-content: space-between; gap: 20px; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #timer-clock { font-size: 2.5em; font-weight: bold; letter-spacing: 2px; }
        #current-task-display { text-align: left; } #current-task-display p { margin: 0; font-size: 1.1em; }
        .priority-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .priority-box { padding: 15px; border-radius: 8px; }
        #box-a { background: #fff5f5; border: 1px solid #e57373; } #box-a h3 { color: #c62828; border-color: #ef9a9a; }
        #box-b { background: #f1f8e9; border: 1px solid #aed581; } #box-b h3 { color: #558b2f; border-color: #c5e1a5; }
        #box-c { background: #fffde7; border: 1px solid #ffd54f; } #box-c h3 { color: #f9a825; border-color: #ffe082; }
        #box-d { background: #f5f5f5; border: 1px solid #e0e0e0; } #box-d h3 { color: #616161; border-color: #eee; }
        .execution-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .execution-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .daily-input { width: 100%; box-sizing: border-box; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .daily-panel button { background-color: #27ae60; width: 100%; padding: 8px; }
        #å®Ÿç¸¾-panel .task-item { cursor: default; }
        .task-item.completed { background-color: #d4edda; border-left-color: #28a745; }
        .task-item.canceled { background-color: #f8d7da; border-left-color: #dc3545; opacity: 0.8; }
        .export-button, #delete-day-data-btn { width: 100%; padding: 12px; margin-top: 15px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; color: white; }
        #export-plan-btn { background-color: #2980b9; } #export-å®Ÿç¸¾-btn { background-color: #8e44ad; }
        #delete-day-data-btn { background-color: #e74c3c; margin-top: 5px; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } .top-bar { justify-content: center; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="notification-bar">
                <span id="notification-status"></span>
                <button id="request-notification-btn" style="display: none;">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã‚’è¨±å¯</button>
            </div>
            <div class="auth-bar">
                <span id="user-info"></span>
                <button id="login-btn">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="logout-btn" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        <div id="main-content" class="main-content">
             <h1>ğŸš€ã€æœ€çµ‚å®Œæˆç‰ˆ Ver.2.2ã€‘æ¥­å‹™ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
             <div class="date-selector-panel">
                <input type="date" id="main-date-picker">
            </div>
            <div class="main-grid">
                <div class="planning-column">
                    <div class="panel daily-panel">
                        <h2>æœ¬æ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h2>
                        <label for="daily-goal"><strong>æœ¬æ—¥ã®ç›®æ¨™</strong></label>
                        <input type="text" id="daily-goal" class="daily-input" placeholder="ä»Šæ—¥é”æˆã—ãŸã„æœ€ã‚‚é‡è¦ãªã“ã¨">
                        <label for="daily-journal"><strong>æœ¬æ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</strong></label>
                        <textarea id="daily-journal" class="daily-input" rows="4" placeholder="ä¸€æ—¥ã®çµ‚ã‚ã‚Šã«æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã‚ˆã†"></textarea>
                        <button id="save-daily-btn">ç›®æ¨™ã¨ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜</button>
                    </div>
                    <div id="plan-panel" class="panel">
                        <h2>è¨ˆç”»ã‚¿ã‚¹ã‚¯</h2>
                        <div class="input-form">
                            <input type="text" id="plan-task-input" placeholder="ã‚¿ã‚¹ã‚¯å">
                            <input type="number" id="plan-duration-input" value="30" min="1" title="äºˆå®šæ™‚é–“(åˆ†)">
                            <button id="add-plan-btn">è¨ˆç”»ã«è¿½åŠ </button>
                        </div>
                        <ul id="plan-list" class="task-list"></ul>
                        <button id="export-plan-btn" class="export-button">ğŸ“‹ è¨ˆç”»ã‚’CSVå‡ºåŠ›</button>
                        <button id="delete-day-data-btn" class="export-button">ğŸ—‘ï¸ ã“ã®æ—¥ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="å®Ÿç¸¾-panel" class="panel">
                        <h2>å®Ÿç¸¾</h2>
                        <ul id="å®Ÿç¸¾-list" class="task-list"></ul>
                        <button id="export-å®Ÿç¸¾-btn" class="export-button">ğŸ“ˆ å®Ÿç¸¾ã‚’CSVå‡ºåŠ›</button>
                    </div>
                </div>
                <div class="execution-column">
                    <div id="execution-panel" class="panel">
                        <h2>å®Ÿè¡Œã¨åˆ†é¡</h2>
                        <div class="execution-top">
                            <div id="current-task-display"><p>å®Ÿè¡Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
                            <div id="timer-clock">00:00</div>
                        </div>
                        <div class="execution-controls">
                            <button id="start-btn" disabled>â–¶ï¸ é–‹å§‹/å†é–‹</button>
                            <button id="pause-btn" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                            <button id="complete-btn" disabled>âœ… å®Œäº†</button>
                            <button id="cancel-btn" disabled>â¹ï¸ ä¸­æ­¢</button>
                        </div>
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                        <div id="urgent-task-panel">
                            <h3>å‰²ã‚Šè¾¼ã¿ã‚¿ã‚¹ã‚¯</h3>
                            <div class="input-form">
                                <input type="text" id="urgent-task-input" placeholder="ç·Šæ€¥ã‚¿ã‚¹ã‚¯å">
                                <input type="number" id="urgent-duration-input" value="15" min="1">
                                <button id="add-urgent-btn">æœ€å„ªå…ˆã«è¿½åŠ </button>
                            </div>
                        </div>
                        <div class="priority-grid">
                            <div id="box-a" class="priority-box"><h3>ğŸ”¥ ç·Šæ€¥ï¼†é‡è¦<br><small>(ä»Šã™ãå–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-a-list" class="task-list"></ul></div>
                            <div id="box-b" class="priority-box"><h3>ğŸŒ± é‡è¦ï¼†éç·Šæ€¥<br><small>(è¨ˆç”»çš„ã«å–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-b-list" class="task-list"></ul></div>
                            <div id="box-c" class="priority-box"><h3>âš¡ï¸ ç·Šæ€¥ï¼†éé‡è¦<br><small>(ç§»è­²ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-c-list" class="task-list"></ul></div>
                            <div id="box-d" class="priority-box"><h3>ğŸ—‘ï¸ éç·Šæ€¥ & éé‡è¦<br><small>(å‰Šé™¤ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-d-list" class="task-list"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FirebaseåˆæœŸåŒ– ---
    const firebaseConfig = {
        apiKey: "AIzaSyD2wKyop5H1UPxbK0VULfpUNAJ5tu4Ia88",
        authDomain: "my-private-task-manegment.firebaseapp.com",
        projectId: "my-private-task-manegment",
        storageBucket: "my-private-task-manegment.appspot.com",
        messagingSenderId: "272952129117",
        appId: "1:272952129117:web:e5ec8adbb79ed76291ffb4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
        let tasks = [];
        let taskCollection, dailyDataCollection;
        let unsubscribeTasks, unsubscribeDaily;
        let timerInterval = null;
        
        const mainDatePicker = document.getElementById('main-date-picker');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const mainContent = document.getElementById('main-content');
        const notificationStatus = document.getElementById('notification-status');
        const requestNotificationBtn = document.getElementById('request-notification-btn');
        const dailyGoalInput = document.getElementById('daily-goal');
        const dailyJournalInput = document.getElementById('daily-journal');
        const saveDailyBtn = document.getElementById('save-daily-btn');
        const planTaskInput = document.getElementById('plan-task-input');
        const planDurationInput = document.getElementById('plan-duration-input');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const allTaskLists = document.querySelectorAll('.task-list');
        const urgentTaskInput = document.getElementById('urgent-task-input');
        const urgentDurationInput = document.getElementById('urgent-duration-input');
        const addUrgentBtn = document.getElementById('add-urgent-btn');
        const currentTaskDisplay = document.getElementById('current-task-display');
        const timerClock = document.getElementById('timer-clock');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const completeBtn = document.getElementById('complete-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const exportPlanBtn = document.getElementById('export-plan-btn');
        const exportå®Ÿç¸¾Btn = document.getElementById('export-å®Ÿç¸¾-btn');
        const deleteDayDataBtn = document.getElementById('delete-day-data-btn');
        const planList = document.getElementById('plan-list');

        auth.onAuthStateChanged(user => {
            if (user) {
                userInfo.textContent = `${user.displayName} ã•ã‚“`;
                loginBtn.style.display = 'none'; logoutBtn.style.display = 'block';
                mainContent.style.display = 'block';
                taskCollection = db.collection('users').doc(user.uid).collection('tasks');
                dailyDataCollection = db.collection('users').doc(user.uid).collection('daily_data');
                loadAllDataForDate(mainDatePicker.value);
                checkNotificationPermission();
            } else {
                userInfo.textContent = '';
                loginBtn.style.display = 'block'; logoutBtn.style.display = 'none';
                mainContent.style.display = 'none';
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeDaily) unsubscribeDaily();
                tasks = [];
                render();
            }
        });

        loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
        logoutBtn.addEventListener('click', () => auth.signOut());

        function loadAllDataForDate(dateStr) {
            if (!auth.currentUser || !dateStr) return;
            if (unsubscribeTasks) unsubscribeTasks();
            unsubscribeTasks = taskCollection.where("plannedDate", "==", dateStr).orderBy("order").onSnapshot(snapshot => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            if (unsubscribeDaily) unsubscribeDaily();
            unsubscribeDaily = dailyDataCollection.doc(dateStr).onSnapshot(doc => {
                const data = doc.exists ? doc.data() : { goal: '', journal: '' };
                dailyGoalInput.value = data.goal || '';
                dailyJournalInput.value = data.journal || '';
            });
        }
        
        saveDailyBtn.addEventListener('click', async () => {
            await dailyDataCollection.doc(mainDatePicker.value).set({ goal: dailyGoalInput.value, journal: dailyJournalInput.value }, { merge: true });
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        deleteDayDataBtn.addEventListener('click', async () => {
            const dateToDelete = mainDatePicker.value;
            if (!confirm(`${dateToDelete}ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã¨ç›®æ¨™ãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            const batch = db.batch();
            const tasksSnapshot = await taskCollection.where("plannedDate", "==", dateToDelete).get();
            tasksSnapshot.forEach(doc => batch.delete(doc.ref));
            const dailyDataRef = dailyDataCollection.doc(dateToDelete);
            batch.delete(dailyDataRef);
            await batch.commit();
            alert(`${dateToDelete}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        });
        
        const alarmSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWcgQmFuZyBzb3VuZCBmcm9tIFNvdW5kQmlibGUuY29tIC8gUmVjb3JkZWQgYnkgTWlrZSBLb2VuaWcAAAAAADh2//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAA4doxGQV9TTQkAAQADADGAlYMAAZYCAwMhJCMjGxsdBAcIAgYGBgUDAwQEBAQEBAMDBAUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUEu//uQxAADACyATUMMMAYAAAQNdAAAFgACAAAFhQAA//uQxAABASxATwMMMAYAAAQI0AAAEgACAAAEhQAA//uQxAAAByxAUQMMMAYAAAPt0AAAIgACAAAHhQAA//uQxAAAECxAUgMMMAYAAANV0AAAJgACAAAFhQAA//uQxAAAICxAUwMMMAYAAAIx0AAAGgACAAAGhQAA//uQxAAADyxAVQMMMAYAAAFN0AAAFgACAAA5hQAA//uQxAAAESxAVgMMMAYAAAIV0AAADgACAAAEhQAA//uQxAAAISxAVwMMMAYAAAGR0AAACgACAAAFhQAA//uQxAAADyxAWQMMMAYAAAD90AAAIAACAAAHhQAA//uQxAAAESxAWgMMMAYAAAFN0AAAEgACAAAFhQAA//uQxAAAIixAWwMMMAYAAACF0AAACgACAAAGhQAA//uQxAAADyxAXQMMMAYAAAEV0AAAGgACAAAEhQAA//uQxAAEECxAXgMMMAYAAAGl0AAAEgACAAAGhQAA//uQxAAEICxAXwMMMAYAAAD50AAAIgACAAAGhQAA//u-');
        
        function showNotification(title, body) {
            alarmSound.play();
            if (!("Notification" in window) || Notification.permission !== 'granted') {
                alert(`${title}\n${body}`);
                return;
            }
            new Notification(title, { body });
        }

        async function addTask(isUrgent = false) {
            let text, duration, taskDate, location, status, order;
            taskDate = mainDatePicker.value;
            if (isUrgent) {
                text = urgentTaskInput.value.trim();
                duration = parseInt(urgentDurationInput.value);
                location = 'box-a-list'; status = 'ready'; order = -1; 
            } else {
                text = planTaskInput.value.trim();
                duration = parseInt(planDurationInput.value);
                location = 'plan-list'; status = 'planned';
                order = tasks.filter(t => t.location === location && t.plannedDate === taskDate).length;
            }
            if (!text || !duration || duration <= 0 || !taskDate) {
                alert('ã‚¿ã‚¹ã‚¯åã€0ã‚ˆã‚Šå¤§ãã„äºˆå®šæ™‚é–“ã€å®Ÿæ–½äºˆå®šæ—¥ã‚’ã™ã¹ã¦æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
            }
            const newTaskData = { text, plannedDuration: duration, status, location, plannedDate: taskDate, actualDate: null, isUrgent, order, createdAt: firebase.firestore.FieldValue.serverTimestamp(), workTime: 0, breakTime: 0, initialWorkTime: 0 };
            await taskCollection.add(newTaskData);
            if (isUrgent) urgentTaskInput.value = ''; else planTaskInput.value = '';
        }

        function render() {
            const sortedTasks = sortTasksForRender();
            allTaskLists. flex-direction: column; gap: 25px; }
        .panel { background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .date-selector-panel { text-align: center; margin-bottom: 20px; }
        #main-date-picker { padding: 10px; font-size: 1.2em; border: 2px solid #3498db; border-radius: 8px; }
        .input-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .input-form input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
        .input-form input[type="text"] { flex-grow: 1; }
        .input-form input[type="number"] { width: 70px; text-align: center; }
        .input-form button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; transition: background-color 0.3s; }
        #add-plan-btn { background-color: #3498db; }
        #add-urgent-btn { background-color: #e74c3c; }
        .task-list { list-style-type: none; padding: 10px; min-height: 60px; border: 2px dashed #e0e0e0; border-radius: 8px; transition: background-color 0.2s; }
        .task-list.drag-over { background-color: #eaf5ff; }
        .task-item { background-color: #ecf0f1; padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; cursor: grab; border-left: 5px solid #3498db; user-select: none; }
        .task-item.dragging { opacity: 0.4; }
        .task-item .task-content { flex-grow: 1; }
        .task-item .task-text { font-weight: 500; word-break: break-all; }
        .task-item .task-details { font-size: 0.85em; color: #7f8c8d; margin-left: 10px; white-space: nowrap; }
        .task-item.urgent { border-left-color: #e74c3c; background-color: #fdeded; }
        .delete-plan-btn { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 1.5em; font-weight: bold; opacity: 0; transition: opacity 0.2s; padding: 0 8px; line-height: 1; }
        .task-item:hover .delete-plan-btn { opacity: 0.6; }
        .delete-plan-btn:hover { opacity: 1; }
        .execution-top { display: flex; align-items: center; justify-content: space-between; gap: 20px; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; transition: background-color 0.5s; }
        #timer-clock { font-size: 2.5em; font-weight: bold; letter-spacing: 2px; }
        #current-task-display { text-align: left; } #current-task-display p { margin: 0; font-size: 1.1em; }
        .priority-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .priority-box { padding: 15px; border-radius: 8px; }
        #box-a { background: #fff5f5; border: 1px solid #e57373; } #box-a h3 { color: #c62828; border-color: #ef9a9a; }
        #box-b { background: #f1f8e9; border: 1px solid #aed581; } #box-b h3 { color: #558b2f; border-color: #c5e1a5; }
        #box-c { background: #fffde7; border: 1px solid #ffd54f; } #box-c h3 { color: #f9a825; border-color: #ffe082; }
        #box-d { background: #f5f5f5; border: 1px solid #e0e0e0; } #box-d h3 { color: #616161; border-color: #eee; }
        .execution-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .execution-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .daily-input { width: 100%; box-sizing: border-box; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .daily-panel button { background-color: #27ae60; width: 100%; padding: 8px; }
        #å®Ÿç¸¾-panel .task-item { cursor: default; }
        .task-item.completed { background-color: #d4edda; border-left-color: #28a745; }
        .task-item.canceled { background-color: #f8d7da; border-left-color: #dc3545; opacity: 0.8; }
        .export-button, #delete-day-data-btn { width: 100%; padding: 12px; margin-top: 15px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; color: white; }
        #export-plan-btn { background-color: #2980b9; } #export-å®Ÿç¸¾-btn { background-color: #8e44ad; }
        #delete-day-data-btn { background-color: #e74c3c; margin-top: 5px; }
        .timer-flashing { animation: flash-bg 1s infinite; }
        @keyframes flash-bg { 50% { background-color: #e74c3c; } }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-bar">
            <span id="user-info"></span>
            <button id="login-btn">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="logout-btn" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div id="main-content" class="main-content">
             <h1>ğŸš€ã€æœ€çµ‚å®Œæˆç‰ˆ Ver.2.2ã€‘æ¥­å‹™ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
             <div class="date-selector-panel">
                <input type="date" id="main-date-picker">
            </div>
            <div class="main-grid">
                <div class="planning-column">
                    <div class="panel daily-panel">
                        <h2>æœ¬æ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h2>
                        <label for="daily-goal"><strong>æœ¬æ—¥ã®ç›®æ¨™</strong></label>
                        <input type="text" id="daily-goal" class="daily-input" placeholder="ä»Šæ—¥é”æˆã—ãŸã„æœ€ã‚‚é‡è¦ãªã“ã¨">
                        <label for="daily-journal"><strong>æœ¬æ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</strong></label>
                        <textarea id="daily-journal" class="daily-input" rows="4" placeholder="ä¸€æ—¥ã®çµ‚ã‚ã‚Šã«æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã‚ˆã†"></textarea>
                        <button id="save-daily-btn">ç›®æ¨™ã¨ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜</button>
                    </div>
                    <div id="plan-panel" class="panel">
                        <h2>è¨ˆç”»ã‚¿ã‚¹ã‚¯</h2>
                        <div class="input-form">
                            <input type="text" id="plan-task-input" placeholder="ã‚¿ã‚¹ã‚¯å">
                            <input type="number" id="plan-duration-input" value="30" min="1" title="äºˆå®šæ™‚é–“(åˆ†)">
                            <button id="add-plan-btn">è¨ˆç”»ã«è¿½åŠ </button>
                        </div>
                        <ul id="plan-list" class="task-list"></ul>
                        <button id="export-plan-btn" class="export-button">ğŸ“‹ è¨ˆç”»ã‚’CSVå‡ºåŠ›</button>
                        <button id="delete-day-data-btn" class="export-button">ğŸ—‘ï¸ ã“ã®æ—¥ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="å®Ÿç¸¾-panel" class="panel">
                        <h2>å®Ÿç¸¾</h2>
                        <ul id="å®Ÿç¸¾-list" class="task-list"></ul>
                        <button id="export-å®Ÿç¸¾-btn" class="export-button">ğŸ“ˆ å®Ÿç¸¾ã‚’CSVå‡ºåŠ›</button>
                    </div>
                </div>
                <div class="execution-column">
                    <div id="execution-panel" class="panel">
                        <h2>å®Ÿè¡Œã¨åˆ†é¡</h2>
                        <div class="execution-top">
                            <div id="current-task-display"><p>å®Ÿè¡Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
                            <div id="timer-clock">00:00</div>
                        </div>
                        <div class="execution-controls">
                            <button id="start-btn" disabled>â–¶ï¸ é–‹å§‹/å†é–‹</button>
                            <button id="pause-btn" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                            <button id="complete-btn" disabled>âœ… å®Œäº†</button>
                            <button id="cancel-btn" disabled>â¹ï¸ ä¸­æ­¢</button>
                        </div>
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                        <div id="urgent-task-panel">
                            <h3>å‰²ã‚Šè¾¼ã¿ã‚¿ã‚¹ã‚¯</h3>
                            <div class="input-form">
                                <input type="text" id="urgent-task-input" placeholder="ç·Šæ€¥ã‚¿ã‚¹ã‚¯å">
                                <input type="number" id="urgent-duration-input" value="15" min="1">
                                <button id="add-urgent-btn">æœ€å„ªå…ˆã«è¿½åŠ </button>
                            </div>
                        </div>
                        <div class="priority-grid">
                            <div id="box-a" class="priority-box"><h3>ğŸ”¥ ç·Šæ€¥ï¼†é‡è¦<br><small>(ä»Šã™ãå–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-a-list" class="task-list"></ul></div>
                            <div id="box-b" class="priority-box"><h3>ğŸŒ± é‡è¦ï¼†éç·Šæ€¥<br><small>(è¨ˆç”»çš„ã«å–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-b-list" class="task-list"></ul></div>
                            <div id="box-c" class="priority-box"><h3>âš¡ï¸ ç·Šæ€¥ï¼†éé‡è¦<br><small>(ç§»è­²ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-c-list" class="task-list"></ul></div>
                            <div id="box-d" class="priority-box"><h3>ğŸ—‘ï¸ éç·Šæ€¥ & éé‡è¦<br><small>(å‰Šé™¤ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-d-list" class="task-list"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FirebaseåˆæœŸåŒ– ---
    const firebaseConfig = {
        apiKey: "AIzaSyD2wKyop5H1UPxbK0VULfpUNAJ5tu4Ia88",
        authDomain: "my-private-task-manegment.firebaseapp.com",
        projectId: "my-private-task-manegment",
        storageBucket: "my-private-task-manegment.appspot.com",
        messagingSenderId: "272952129117",
        appId: "1:272952129117:web:e5ec8adbb79ed76291ffb4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
        let tasks = [];
        let taskCollection;
        let dailyDataCollection;
        let unsubscribeTasks, unsubscribeDaily;
        let timerInterval = null;
        let notificationInterval = null; // â˜…é€šçŸ¥ç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID
        
        const mainDatePicker = document.getElementById('main-date-picker');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const mainContent = document.getElementById('main-content');
        const dailyGoalInput = document.getElementById('daily-goal');
        const dailyJournalInput = document.getElementById('daily-journal');
        const saveDailyBtn = document.getElementById('save-daily-btn');
        const planTaskInput = document.getElementById('plan-task-input');
        const planDurationInput = document.getElementById('plan-duration-input');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const allTaskLists = document.querySelectorAll('.task-list');
        const urgentTaskInput = document.getElementById('urgent-task-input');
        const urgentDurationInput = document.getElementById('urgent-duration-input');
        const addUrgentBtn = document.getElementById('add-urgent-btn');
        const executionTop = document.querySelector('.execution-top');
        const currentTaskDisplay = document.getElementById('current-task-display');
        const timerClock = document.getElementById('timer-clock');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const completeBtn = document.getElementById('complete-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const exportPlanBtn = document.getElementById('export-plan-btn');
        const exportå®Ÿç¸¾Btn = document.getElementById('export-å®Ÿç¸¾-btn');
        const deleteDayDataBtn = document.getElementById('delete-day-data-btn');
        const planList = document.getElementById('plan-list');

        auth.onAuthStateChanged(user => {
            if (user) {
                userInfo.textContent = `${user.displayName} ã•ã‚“`;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                mainContent.style.display = 'block';
                taskCollection = db.collection('users').doc(user.uid).collection('tasks');
                dailyDataCollection = db.collection('users').doc(user.uid).collection('daily_data');
                loadAllDataForDate(mainDatePicker.value);
            } else {
                userInfo.textContent = '';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                mainContent.style.display = 'none';
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeDaily) unsubscribeDaily();
                tasks = [];
                render();
            }
        });

        loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
        logoutBtn.addEventListener('click', () => auth.signOut());

        function loadAllDataForDate(dateStr) {
            if (!auth.currentUser || !dateStr) return;
            if (unsubscribeTasks) unsubscribeTasks();
            unsubscribeTasks = taskCollection.where("plannedDate", "==", dateStr).orderBy("order").onSnapshot(snapshot => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            if (unsubscribeDaily) unsubscribeDaily();
            unsubscribeDaily = dailyDataCollection.doc(dateStr).onSnapshot(doc => {
                const data = doc.exists ? doc.data() : { goal: '', journal: '' };
                dailyGoalInput.value = data.goal || '';
                dailyJournalInput.value = data.journal || '';
            });
        }
        
        saveDailyBtn.addEventListener('click', async () => {
            await dailyDataCollection.doc(mainDatePicker.value).set({ goal: dailyGoalInput.value, journal: dailyJournalInput.value }, { merge: true });
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        deleteDayDataBtn.addEventListener('click', async () => {
            const dateToDelete = mainDatePicker.value;
            if (!confirm(`${dateToDelete}ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã¨ç›®æ¨™ãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            const batch = db.batch();
            const tasksSnapshot = await taskCollection.where("plannedDate", "==", dateToDelete).get();
            tasksSnapshot.forEach(doc => batch.delete(doc.ref));
            const dailyDataRef = dailyDataCollection.doc(dateToDelete);
            batch.delete(dailyDataRef);
            await batch.commit();
            alert(`${dateToDelete}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        });
        
        const alarmSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWcgQmFuZyBzb3VuZCBmcm9tIFNvdW5kQmlibGUuY29tIC8gUmVjb3JkZWQgYnkgTWlrZSBLb2VuaWcAAAAAADh2//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAA4doxGQV9TTQkAAQADADGAlYMAAZYCAwMhJCMjGxsdBAcIAgYGBgUDAwQEBAQEBAMDBAUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFB0%; box-sizing: border-box; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .daily-panel button { background-color: #27ae60; width: 100%; padding: 8px; }
        #å®Ÿç¸¾-panel .task-item { cursor: default; }
        .task-item.completed { background-color: #d4edda; border-left-color: #28a745; }
        .task-item.canceled { background-color: #f8d7da; border-left-color: #dc3545; opacity: 0.8; }
        .export-button, #delete-day-data-btn { width: 100%; padding: 12px; margin-top: 15px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; color: white; }
        #export-plan-btn { background-color: #2980b9; } #export-å®Ÿç¸¾-btn { background-color: #8e44ad; }
        #delete-day-data-btn { background-color: #e74c3c; margin-top: 5px; }
        body.timer-finished-flash { animation: flash-background 1s 3; }
        @keyframes flash-background {
            0%, 100% { background-color: #f0f2f5; }
            50% { background-color: #e74c3c; }
        }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-bar">
            <span id="user-info"></span>
            <button id="login-btn">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="logout-btn" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div id="main-content" class="main-content">
             <h1>ğŸš€ã€æœ€çµ‚å®Œæˆç‰ˆ Ver.3.0ã€‘æ¥­å‹™ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
             <div class="date-selector-panel">
                <input type="date" id="main-date-picker">
            </div>
            <div class="main-grid">
                <div class="planning-column">
                    <div class="panel daily-panel">
                        <h2>æœ¬æ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h2>
                        <label for="daily-goal"><strong>æœ¬æ—¥ã®ç›®æ¨™</strong></label>
                        <input type="text" id="daily-goal" class="daily-input" placeholder="ä»Šæ—¥é”æˆã—ãŸã„æœ€ã‚‚é‡è¦ãªã“ã¨">
                        <label for="daily-journal"><strong>æœ¬æ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</strong></label>
                        <textarea id="daily-journal" class="daily-input" rows="4" placeholder="ä¸€æ—¥ã®çµ‚ã‚ã‚Šã«æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã‚ˆã†"></textarea>
                        <button id="save-daily-btn">ç›®æ¨™ã¨ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜</button>
                    </div>
                    <div id="plan-panel" class="panel">
                        <h2>è¨ˆç”»ã‚¿ã‚¹ã‚¯</h2>
                        <div class="input-form">
                            <input type="text" id="plan-task-input" placeholder="ã‚¿ã‚¹ã‚¯å">
                            <input type="number" id="plan-duration-input" value="30" min="1" title="äºˆå®šæ™‚é–“(åˆ†)">
                            <button id="add-plan-btn">è¨ˆç”»ã«è¿½åŠ </button>
                        </div>
                        <ul id="plan-list" class="task-list"></ul>
                        <button id="export-plan-btn" class="export-button">ğŸ“‹ è¨ˆç”»ã‚’CSVå‡ºåŠ›</button>
                        <button id="delete-day-data-btn" class="export-button">ğŸ—‘ï¸ ã“ã®æ—¥ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="å®Ÿç¸¾-panel" class="panel">
                        <h2>å®Ÿç¸¾</h2>
                        <ul id="å®Ÿç¸¾-list" class="task-list"></ul>
                        <button id="export-å®Ÿç¸¾-btn" class="export-button">ğŸ“ˆ å®Ÿç¸¾ã‚’CSVå‡ºåŠ›</button>
                    </div>
                </div>
                <div class="execution-column">
                    <div id="execution-panel" class="panel">
                        <h2>å®Ÿè¡Œã¨åˆ†é¡</h2>
                        <div class="execution-top">
                            <div id="current-task-display"><p>å®Ÿè¡Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
                            <div id="timer-clock">00:00</div>
                        </div>
                        <div class="execution-controls">
                            <button id="start-btn" disabled>â–¶ï¸ é–‹å§‹/å†é–‹</button>
                            <button id="pause-btn" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                            <button id="complete-btn" disabled>âœ… å®Œäº†</button>
                            <button id="cancel-btn" disabled>â¹ï¸ ä¸­æ­¢</button>
                        </div>
                        <hr style="margin: 20px 0; border: 1px solid #eee;">
                        <div id="urgent-task-panel">
                            <h3>å‰²ã‚Šè¾¼ã¿ã‚¿ã‚¹ã‚¯</h3>
                            <div class="input-form">
                                <input type="text" id="urgent-task-input" placeholder="ç·Šæ€¥ã‚¿ã‚¹ã‚¯å">
                                <input type="number" id="urgent-duration-input" value="15" min="1">
                                <button id="add-urgent-btn">æœ€å„ªå…ˆã«è¿½åŠ </button>
                            </div>
                        </div>
                        <div class="priority-grid">
                            <div id="box-a" class="priority-box"><h3>ğŸ”¥ ç·Šæ€¥ï¼†é‡è¦<br><small>(ä»Šã™ãå–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-a-list" class="task-list"></ul></div>
                            <div id="box-b" class="priority-box"><h3>ğŸŒ± é‡è¦ï¼†éç·Šæ€¥<br><small>(è¨ˆç”»çš„ã«å–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-b-list" class="task-list"></ul></div>
                            <div id="box-c" class="priority-box"><h3>âš¡ï¸ ç·Šæ€¥ï¼†éé‡è¦<br><small>(ç§»è­²ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-c-list" class="task-list"></ul></div>
                            <div id="box-d" class="priority-box"><h3>ğŸ—‘ï¸ éç·Šæ€¥ & éé‡è¦<br><small>(å‰Šé™¤ã§ãã‚‹ã‚¿ã‚¹ã‚¯)</small></h3><ul id="box-d-list" class="task-list"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FirebaseåˆæœŸåŒ– ---
    const firebaseConfig = {
        apiKey: "AIzaSyD2wKyop5H1UPxbK0VULfpUNAJ5tu4Ia88",
        authDomain: "my-private-task-manegment.firebaseapp.com",
        projectId: "my-private-task-manegment",
        storageBucket: "my-private-task-manegment.appspot.com",
        messagingSenderId: "272952129117",
        appId: "1:272952129117:web:e5ec8adbb79ed76291ffb4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
        let tasks = [];
        let taskCollection;
        let dailyDataCollection;
        let unsubscribeTasks, unsubscribeDaily;
        let timerInterval = null;
        
        const mainDatePicker = document.getElementById('main-date-picker');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const mainContent = document.getElementById('main-content');
        const dailyGoalInput = document.getElementById('daily-goal');
        const dailyJournalInput = document.getElementById('daily-journal');
        const saveDailyBtn = document.getElementById('save-daily-btn');
        const planTaskInput = document.getElementById('plan-task-input');
        const planDurationInput = document.getElementById('plan-duration-input');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const allTaskLists = document.querySelectorAll('.task-list');
        const urgentTaskInput = document.getElementById('urgent-task-input');
        const urgentDurationInput = document.getElementById('urgent-duration-input');
        const addUrgentBtn = document.getElementById('add-urgent-btn');
        const currentTaskDisplay = document.getElementById('current-task-display');
        const timerClock = document.getElementById('timer-clock');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const completeBtn = document.getElementById('complete-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const exportPlanBtn = document.getElementById('export-plan-btn');
        const exportå®Ÿç¸¾Btn = document.getElementById('export-å®Ÿç¸¾-btn');
        const deleteDayDataBtn = document.getElementById('delete-day-data-btn');
        const planList = document.getElementById('plan-list');

        // â˜…â˜…â˜… é€šçŸ¥æ©Ÿèƒ½ã®åˆæœŸåŒ– â˜…â˜…â˜…
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                userInfo.textContent = `${user.displayName} ã•ã‚“`;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                mainContent.style.display = 'block';
                taskCollection = db.collection('users').doc(user.uid).collection('tasks');
                dailyDataCollection = db.collection('users').doc(user.uid).collection('daily_data');
                loadAllDataForDate(mainDatePicker.value);
            } else {
                userInfo.textContent = '';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                mainContent.style.display = 'none';
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeDaily) unsubscribeDaily();
                tasks = [];
                render();
            }
        });

        loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
        logoutBtn.addEventListener('click', () => auth.signOut());

        function loadAllDataForDate(dateStr) {
            if (!auth.currentUser || !dateStr) return;
            if (unsubscribeTasks) unsubscribeTasks();
            unsubscribeTasks = taskCollection.where("plannedDate", "==", dateStr).orderBy("order").onSnapshot(snapshot => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            if (unsubscribeDaily) unsubscribeDaily();
            unsubscribeDaily = dailyDataCollection.doc(dateStr).onSnapshot(doc => {
                const data = doc.exists ? doc.data() : { goal: '', journal: '' };
                dailyGoalInput.value = data.goal || '';
                dailyJournalInput.value = data.journal || '';
            });
        }
        
        saveDailyBtn.addEventListener('click', async () => {
            await dailyDataCollection.doc(mainDatePicker.value).set({ goal: dailyGoalInput.value, journal: dailyJournalInput.value }, { merge: true });
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        });

        deleteDayDataBtn.addEventListener('click', async () => {
            const dateToDelete = mainDatePicker.value;
            if (!confirm(`${dateToDelete}ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã¨ç›®æ¨™ãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            const batch = db.batch();
            const tasksSnapshot = await taskCollection.where("plannedDate", "==", dateToDelete).get();
            tasksSnapshot.forEach(doc => batch.delete(doc.ref));
            const dailyDataRef = dailyDataCollection.doc(dateToDelete);
            batch.delete(dailyDataRef);
            await batch.commit();
            alert(`${dateToDelete}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        });
        
        const alarmSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWcgQmFuZyBzb3VuZCBmcm9tIFNvdW5kQmlibGUuY29tIC8gUmVjb3JkZWQgYnkgTWlrZSBLb2VuaWcAAAAAADh2//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAA4doxGQV9TTQkAAQADADGAlYMAAZYCAwMhJCMjGxsdBAcIAgYGBgUDAwQEBAQEBAMDBAUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUEu//uQxAADACyATUMMMAYAAAQNdAAAFgACAAAFhQAA//uQxAABASxATwMMMAYAAAQI0AAAEgACAAAEhQAA//uQxAAAByxAUQMMMAYAAAPt0AAAIgACAAAHhQAA//uQxAAAECxAUgMMMAYAAANV0AAAJgACAAAFhQAA//uQxAAAICxAUwMMMAYAAAIx0AAAGgACAAAGhQAA//uQxAAADyxAVQMMMAYAAAFN0AAAFgACAAA5hQAA//uQxAAAESxAVgMMMAYAAAIV0AAADgACAAAEhQAA//uQxAAAISxAVwMMMAYAAAGR0AAACgACAAAFhQAA//uQxAAADyxAWQMMMAYAAAD90AAAIAACAAAHhQAA//uQxAAAESxAWgMMMAYAAAFN0AAAEgACAAAFhQAA//uQxAAAIixAWwMMMAYAAACF0AAACgACAAAGhQAA//uQxAAADyxAXQMMMAYAAAEV0AAAGgACAAAEhQAA//uQxAAEECxAXgMMMAYAAAGl0AAAEgACAAAGhQAA//uQxAAEICxAXwMMMAYAAAD50AAAIgACAAAGhQAA//u-');
        
        async function addTask(isUrgent = false) {
            let text, duration, taskDate, location, status, order;
            taskDate = mainDatePicker.value;
            if (isUrgent) {
                text = urgentTaskInput.value.trim();
                duration = parseInt(urgentDurationInput.value);
                location = 'box-a-list';
                status = 'ready';
                order = -1; 
            } else {
                text = planTaskInput.value.trim();
                duration = parseInt(planDurationInput.value);
                location = 'plan-list';
                status = 'planned';
                order = tasks.filter(t => t.location === location && t.plannedDate === taskDate).length;
            }
            if (!text || !duration || duration <= 0 || !taskDate) {
                alert('ã‚¿ã‚¹ã‚¯åã€0ã‚ˆã‚Šå¤§ãã„äºˆå®šæ™‚é–“ã€å®Ÿæ–½äºˆå®šæ—¥ã‚’ã™ã¹ã¦æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
            }
            const newTaskData = { text, plannedDuration: duration, status, location, plannedDate: taskDate, actualDate: null, isUrgent, order, createdAt: firebase.firestore.FieldValue.serverTimestamp(), workTime: 0, breakTime: 0, initialWorkTime: 0 };
            await taskCollection.add(newTaskData);
            if (isUrgent) urgentTaskInput.value = ''; else planTaskInput.value = '';
        }

        function render() {
            const sortedTasks = sortTasksForRender();
            allTaskLists.forEach(list => list.innerHTML = '');
            sortedTasks.forEach(task => {
                const taskListEl = document.getElementById(task.location);
                if (taskListEl) {
                    const taskItem = createTaskElement(task);
                    taskListEl.appendChild(taskItem);
                }
            });
            updateCurrentTaskDisplay();
        }
        function sortTasksForRender() { return tasks.slice().sort((a, b) => (a.order || 0) - (b.order || 0)); }
        function createTaskElement(task) {
            const item = document.createElement('li');
            item.className = `task-item ${task.status} ${task.isUrgent ? 'urgent' : ''}`;
            item.dataset.id = task.id;
            item.setAttribute('draggable', !['completed', 'canceled'].includes(task.status));
            const contentDiv = document.createElement('div');
            contentDiv.className = 'task-content';
            const workTimeMin = Math.ceil((task.workTime || 0) / 60);
            if (['completed', 'canceled'].includes(task.status)) {
                contentDiv.innerHTML = `<span class="task-text">${task.text}</span><span class="task-details">å®Ÿç¸¾: ${workTimeMin}åˆ†</span>`;
            } else {
                contentDiv.innerHTML = `<span class="task-text">${task.text}</span><span class="task-details">${task.plannedDuration}åˆ†</span>`;
            }
            item.appendChild(contentDiv);
            if (task.location === 'plan-list') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-plan-btn';
                deleteBtn.title = 'è¨ˆç”»ã‹ã‚‰å‰Šé™¤';
                deleteBtn.innerHTML = 'Ã—';
                item.appendChild(deleteBtn);
            }
            return item;
        }

        function findNextTask() {
            const activeTask = tasks.find(t => ['working', 'paused'].includes(t.status));
            if (activeTask) return activeTask;
            const priorityOrder = ['box-a-list', 'box-b-list', 'box-c-list', 'box-d-list'];
            for (const listId of priorityOrder) {
                const task = sortTasksForRender().find(t => t.location === listId);
                if (task) return task;
            }
            return null;
        }
        function updateCurrentTaskDisplay() {
            const currentTask = findNextTask();
            const originalTitle = document.querySelector('title').textContent;
            if (!currentTask) {
                currentTaskDisplay.innerHTML = `<p>å®Ÿè¡Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
                timerClock.textContent = '00:00';
                updateControlButtons('initial');
                document.title = originalTitle.split(" - ")[0]; // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…ƒã«æˆ»ã™
                return;
            }
            const remainingTime = (currentTask.plannedDuration * 60) - (currentTask.workTime || 0);
            currentTaskDisplay.innerHTML = `<p>${currentTask.text}</p><small>äºˆå®š: ${currentTask.plannedDuration}åˆ†</small>`;
            timerClock.textContent = formatTime(remainingTime < 0 ? 0 : remainingTime);
            if(currentTask.status === 'working') {
                document.title = `${timerClock.textContent} - ${currentTask.text}`;
            } else {
                 document.title = originalTitle.split(" - ")[0];
            }
            updateControlButtons(currentTask.status);
        }
        function formatTime(seconds) { return `${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`; }
        function updateControlButtons(status) {
            startBtn.disabled = !['ready', 'paused'].includes(status);
            pauseBtn.disabled = status !== 'working';
            completeBtn.disabled = !['ready', 'working', 'paused'].includes(status);
            cancelBtn.disabled = !['ready', 'working', 'paused'].includes(status);
        }
        
        async function startTimer() {
            const task = findNextTask();
            if (!task || task.status === 'working') return;
            const updates = { status: 'working', startTime: Date.now(), initialWorkTime: task.workTime || 0 };
            if (!task.actualDate) updates.actualDate = new Date().toISOString().split('T')[0];
            await updateTask(task.id, updates);
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const currentTask = tasks.find(t => t.id === task.id);
                if (!currentTask || currentTask.status !== 'working') return clearInterval(timerInterval);
                const elapsed = Math.floor((Date.now() - currentTask.startTime) / 1000);
                const workTime = currentTask.initialWorkTime + elapsed;
                const remainingTime = (currentTask.plannedDuration * 60) - workTime;
                
                timerClock.textContent = formatTime(remainingTime < 0 ? 0 : remainingTime);
                document.title = `${timerClock.textContent} - ${currentTask.text}`;

                if (remainingTime < 0) {
                    handleTimerCompletion(currentTask);
                }
            }, 1000);
        }

        async function handleTimerCompletion(task) {
            clearInterval(timerInterval);
            alarmSound.play();
            
            // 1. è¦–è¦šé€šçŸ¥ï¼ˆç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
            document.body.classList.add('timer-finished-flash');
            setTimeout(() => document.body.classList.remove('timer-finished-flash'), 3000);

            // 2. è¦–è¦šé€šçŸ¥ï¼ˆã‚¿ãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
            document.title = `â°æ™‚é–“ã§ã™ï¼- ${task.text}`;

            // 3. è¦–è¦šé€šçŸ¥ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ï¼‰
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`ã€Œ${task.text}ã€ã®äºˆå®šæ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸï¼`, {
                    body: 'ä¼‘æ†©ã—ã¦æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚',
                    icon: 'https://img.icons8.com/plasticine/100/000000/alarm-clock.png'
                });
            } else {
                alert(`ã€Œ${task.text}ã€ã®äºˆå®šæ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸï¼`);
            }
            
            // ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’æ›´æ–°
            await updateTask(task.id, { status: 'paused', workTime: task.plannedDuration * 60 });
        }

        async function pauseTimer() {
            const task = tasks.find(t => t.status === 'working');
            if (task) {
                clearInterval(timerInterval);
                const elapsed = Math.floor((Date.now() - task.startTime) / 1000);
                const newWorkTime = task.initialWorkTime + elapsed;
                await updateTask(task.id, { status: 'paused', workTime: newWorkTime });
            }
        }
        
        async function changeStatus(status) {
            const task = findNextTask();
            if (!task) return;
            if (task.status === 'working') await pauseTimer();
            await updateTask(task.id, { status, location: 'å®Ÿç¸¾-list' });
        }

        async function updateTask(taskId, data) { await taskCollection.doc(String(taskId)).update(data); }
        
        function setupDragAndDrop() {
            let draggedItemId = null;
            document.addEventListener('dragstart', e => { if (e.target.classList.contains('task-item')) { draggedItemId = e.target.dataset.id; setTimeout(() => e.target.classList.add('dragging'), 0); } });
            document.addEventListener('dragend', e => { if (e.target.classList.contains('task-item')) { e.target.classList.remove('dragging'); draggedItemId = null; } });
            allTaskLists.forEach(list => {
                list.addEventListener('dragover', e => { e.preventDefault(); list.classList.add('drag-over'); });
                list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
                list.addEventListener('drop', async e => {
                    e.preventDefault(); list.classList.remove('drag-over'); if (!draggedItemId) return;
                    const draggedEl = document.querySelector(`[data-id="${draggedItemId}"]`);
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (afterElement) list.insertBefore(draggedEl, afterElement); else list.appendChild(draggedEl);
                    const newOrderIds = Array.from(list.children).map(item => item.dataset.id);
                    const batch = db.batch();
                    newOrderIds.forEach((id, index) => {
                        const taskDocRef = taskCollection.doc(String(id));
                        const task = tasks.find(t => t.id === id);
                        if(task){
                            const updates = { location: list.id, order: index };
                            if (list.id.startsWith('box-')) {
                                updates.originalLocation = list.id;
                                if(task.status === 'planned') updates.status = 'ready';
                            }
                            batch.update(taskDocRef, updates);
                        }
                    });
                    await batch.commit();
                });
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset, element: child };
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function exportCsv(type) {
            const date = mainDatePicker.value;
            let data, header, filename;
            const priorityMap = { 'box-a-list': 'A:ç·Šæ€¥&é‡è¦', 'box-b-list': 'B:é‡è¦&éç·Šæ€¥', 'box-c-list': 'C:ç·Šæ€¥&éé‡è¦', 'box-d-list': 'D:éç·Šæ€¥&éé‡è¦' };
            if (type === 'plan') {
                data = tasks.filter(t => t.location === 'plan-list');
                if (data.length === 0) return alert('å‡ºåŠ›ã™ã‚‹è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                header = ['æ—¥ä»˜', 'ã‚¿ã‚¹ã‚¯å', 'äºˆå®šæ™‚é–“(åˆ†)'];
                filename = `è¨ˆç”»_${date}.csv`;
                const rows = data.map(t => [t.plannedDate, `"${t.text.replace(/"/g, '""')}"`, t.plannedDuration]);
                triggerDownload("data:text/csv;charset=utf-8,\uFEFF" + [header.join(','), ...rows.map(e => e.join(','))].join('\n'), filename);
            } else {
                data = tasks.filter(t => t.location === 'å®Ÿç¸¾-list');
                if (data.length === 0) return alert('å‡ºåŠ›ã™ã‚‹å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                header = ['å®Ÿæ–½æ—¥', 'å„ªå…ˆåº¦', 'ã‚¿ã‚¹ã‚¯å', 'ä½œæ¥­æ™‚é–“(åˆ†)', 'ä¼‘æ†©æ™‚é–“(åˆ†)'];
                filename = `å®Ÿç¸¾_${date}.csv`;
                 const rows = data.map(t => {
                    const priority = priorityMap[t.originalLocation] || (t.isUrgent ? 'A:ç·Šæ€¥&é‡è¦' : 'N/A');
                    return [t.actualDate, priority, `"${t.text.replace(/"/g, '""')}"`, Math.ceil((t.workTime || 0)/60), Math.ceil((t.breakTime || 0)/60)];
                });
                triggerDownload("data:text/csv;charset=utf-8,\uFEFF" + [header.join(','), ...rows.map(e => e.join(','))].join('\n'), filename);
            }
        }
        function triggerDownload(uri, filename) { const link = document.createElement('a'); link.setAttribute('href', encodeURI(uri)); link.setAttribute('download', filename); link.click(); }

        mainDatePicker.addEventListener('change', (e) => loadAllDataForDate(e.target.value));
        addPlanBtn.addEventListener('click', () => addTask(false));
        addUrgentBtn.addEventListener('click', () => addTask(true));
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        completeBtn.addEventListener('click', () => changeStatus('completed'));
        cancelBtn.addEventListener('click', () => changeStatus('canceled'));
        exportPlanBtn.addEventListener('click', () => exportCsv('plan'));
        exportå®Ÿç¸¾Btn.addEventListener('click', () => exportCsv('å®Ÿç¸¾'));
        planList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-plan-btn')) {
                const taskItem = e.target.closest('.task-item');
                const taskId = taskItem.dataset.id;
                if (confirm(`è¨ˆç”»ã‚¿ã‚¹ã‚¯ã€Œ${taskItem.querySelector('.task-text').textContent}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    await taskCollection.doc(taskId).delete();
                }
            }
        });
        
        mainDatePicker.value = new Date().toISOString().split('T')[0];
        setupDragAndDrop();
        if (auth.currentUser) {
            loadAllDataForDate(mainDatePicker.value);
        } else {
            render();
        }
    });
</script>
</body>
</html>
```forEach(list => list.innerHTML = '');
            sortedTasks.forEach(task => {
                const taskListEl = document.getElementById(task.location);
                if (taskListEl) {
                    const taskItem = createTaskElement(task);
                    taskListEl.appendChild(taskItem);
                }
            });
            updateCurrentTaskDisplay();
        }
        function sortTasksForRender() { return tasks.slice().sort((a, b) => (a.order || 0) - (b.order || 0)); }
        function createTaskElement(task) {
            const item = document.createElement('li');
            item.className = `task-item ${task.status} ${task.isUrgent ? 'urgent' : ''}`;
            item.dataset.id = task.id;
            item.setAttribute('draggable', !['completed', 'canceled'].includes(task.status));
            const contentDiv = document.createElement('div');
            contentDiv.className = 'task-content';
            const workTimeMin = Math.ceil((task.workTime || 0) / 60);
            if (['completed', 'canceled'].includes(task.status)) {
                contentDiv.innerHTML = `<span class="task-text">${task.text}</span><span class="task-details">å®Ÿç¸¾: ${workTimeMin}åˆ†</span>`;
            } else {
                contentDiv.innerHTML = `<span class="task-text">${task.text}</span><span class="task-details">${task.plannedDuration}åˆ†</span>`;
            }
            item.appendChild(contentDiv);
            if (task.location === 'plan-list') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-plan-btn';
                deleteBtn.title = 'è¨ˆç”»ã‹ã‚‰å‰Šé™¤';
                deleteBtn.innerHTML = 'Ã—';
                item.appendChild(deleteBtn);
            }
            return item;
        }

        function findNextTask() {
            const activeTask = tasks.find(t => ['working', 'paused'].includes(t.status));
            if (activeTask) return activeTask;
            const priorityOrder = ['box-a-list', 'box-b-list', 'box-c-list', 'box-d-list'];
            for (const listId of priorityOrder) {
                const task = sortTasksForRender().find(t => t.location === listId);
                if (task) return task;
            }
            return null;
        }
        function updateCurrentTaskDisplay() {
            const currentTask = findNextTask();
            if (!currentTask) {
                currentTaskDisplay.innerHTML = `<p>å®Ÿè¡Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
                timerClock.textContent = '00:00';
                updateControlButtons('initial');
                return;
            }
            const remainingTime = (currentTask.plannedDuration * 60) - (currentTask.workTime || 0);
            currentTaskDisplay.innerHTML = `<p>${currentTask.text}</p><small>äºˆå®š: ${currentTask.plannedDuration}åˆ†</small>`;
            timerClock.textContent = formatTime(remainingTime < 0 ? 0 : remainingTime);
            updateControlButtons(currentTask.status);
        }
        function formatTime(seconds) { return `${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`; }
        function updateControlButtons(status) {
            startBtn.disabled = !['ready', 'paused'].includes(status);
            pauseBtn.disabled = status !== 'working';
            completeBtn.disabled = !['ready', 'working', 'paused'].includes(status);
            cancelBtn.disabled = !['ready', 'working', 'paused'].includes(status);
        }
        
        async function startTimer() {
            const task = findNextTask();
            if (!task || task.status === 'working') return;
            const updates = { status: 'working', startTime: Date.now(), initialWorkTime: task.workTime || 0 };
            if (!task.actualDate) updates.actualDate = new Date().toISOString().split('T')[0];
            await updateTask(task.id, updates);
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const currentTask = tasks.find(t => t.id === task.id);
                if (!currentTask || currentTask.status !== 'working') return clearInterval(timerInterval);
                const elapsed = Math.floor((Date.now() - currentTask.startTime) / 1000);
                const workTime = currentTask.initialWorkTime + elapsed;
                const remainingTime = (currentTask.plannedDuration * 60) - workTime;
                
                timerClock.textContent = formatTime(remainingTime < 0 ? 0 : remainingTime);
                if (remainingTime < 0) {
                    pauseTimer();
                    showNotification('æ™‚é–“ã§ã™ï¼', `ã€Œ${currentTask.text}ã€ã®äºˆå®šæ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸï¼`);
                }
            }, 1000);
        }

        async function pauseTimer() {
            const task = tasks.find(t => t.status === 'working');
            if (task) {
                clearInterval(timerInterval);
                const elapsed = Math.floor((Date.now() - task.startTime) / 1000);
                const newWorkTime = task.initialWorkTime + elapsed;
                await updateTask(task.id, { status: 'paused', workTime: newWorkTime });
            }
        }
        
        async function changeStatus(status) {
            const task = findNextTask();
            if (!task) return;
            if (task.status === 'working') await pauseTimer();
            const finalTaskState = tasks.find(t => t.id === task.id);
            await updateTask(task.id, { status, location: 'å®Ÿç¸¾-list' });
        }

        async function updateTask(taskId, data) { await taskCollection.doc(String(taskId)).update(data); }
        
        function setupDragAndDrop() {
            let draggedItemId = null;
            document.addEventListener('dragstart', e => { if (e.target.classList.contains('task-item')) { draggedItemId = e.target.dataset.id; setTimeout(() => e.target.classList.add('dragging'), 0); } });
            document.addEventListener('dragend', e => { if (e.target.classList.contains('task-item')) { e.target.classList.remove('dragging'); draggedItemId = null; } });
            allTaskLists.forEach(list => {
                list.addEventListener('dragover', e => { e.preventDefault(); list.classList.add('drag-over'); });
                list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
                list.addEventListener('drop', async e => {
                    e.preventDefault();
                    list.classList.remove('drag-over');
                    if (!draggedItemId) return;

                    const draggedEl = document.querySelector(`[data-id="${draggedItemId}"]`);
                    const afterElement = getDragAfterElement(list, e.clientY);
                    
                    if (afterElement) list.insertBefore(draggedEl, afterElement);
                    else list.appendChild(draggedEl);

                    const newOrderIds = Array.from(list.children).map(item => item.dataset.id);
                    const batch = db.batch();
                    newOrderIds.forEach((id, index) => {
                        const taskDocRef = taskCollection.doc(String(id));
                        const task = tasks.find(t => t.id === id);
                        if(task){
                            const updates = { location: list.id, order: index };
                            if (list.id.startsWith('box-')) {
                                updates.originalLocation = list.id;
                                if(task.status === 'planned') updates.status = 'ready';
                            }
                            batch.update(taskDocRef, updates);
                        }
                    });
                    await batch.commit();
                });
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset, element: child };
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function exportCsv(type) {
            const date = mainDatePicker.value;
            let data, header, filename;
            const priorityMap = { 'box-a-list': 'A:ç·Šæ€¥&é‡è¦', 'box-b-list': 'B:é‡è¦&éç·Šæ€¥', 'box-c-list': 'C:ç·Šæ€¥&éé‡è¦', 'box-d-list': 'D:éç·Šæ€¥&éé‡è¦' };
            if (type === 'plan') {
                data = tasks.filter(t => t.location === 'plan-list');
                if (data.length === 0) return alert('å‡ºåŠ›ã™ã‚‹è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                header = ['æ—¥ä»˜', 'ã‚¿ã‚¹ã‚¯å', 'äºˆå®šæ™‚é–“(åˆ†)'];
                filename = `è¨ˆç”»_${date}.csv`;
                const rows = data.map(t => [t.plannedDate, `"${t.text.replace(/"/g, '""')}"`, t.plannedDuration]);
                triggerDownload("data:text/csv;charset=utf-8,\uFEFF" + [header.join(','), ...rows.map(e => e.join(','))].join('\n'), filename);
            } else {
                data = tasks.filter(t => t.location === 'å®Ÿç¸¾-list');
                if (data.length === 0) return alert('å‡ºåŠ›ã™ã‚‹å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                header = ['å®Ÿæ–½æ—¥', 'å„ªå…ˆåº¦', 'ã‚¿ã‚¹ã‚¯å', 'ä½œæ¥­æ™‚é–“(åˆ†)', 'ä¼‘æ†©æ™‚é–“(åˆ†)'];
                filename = `å®Ÿç¸¾_${date}.csv`;
                 const rows = data.map(t => {
                    const priority = priorityMap[t.originalLocation] || (t.isUrgent ? 'A:ç·Šæ€¥&é‡è¦' : 'N/A');
                    return [t.actualDate, priority, `"${t.text.replace(/"/g, '""')}"`, Math.ceil((t.workTime || 0)/60), Math.ceil((t.breakTime || 0)/60)];
                });
                triggerDownload("data:text/csv;charset=utf-8,\uFEFF" + [header.join(','), ...rows.map(e => e.join(','))].join('\n'), filename);
            }
        }
        function triggerDownload(uri, filename) { const link = document.createElement('a'); link.setAttribute('href', encodeURI(uri)); link.setAttribute('download', filename); link.click(); }

        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                notificationStatus.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“";
            } else if (Notification.permission === 'granted') {
                notificationStatus.textContent = "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ï¼šè¨±å¯æ¸ˆã¿";
                requestNotificationBtn.style.display = 'none';
            } else if (Notification.permission !== 'denied') {
                notificationStatus.textContent = "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ï¼šæœªè¨±å¯";
                requestNotificationBtn.style.display = 'block';
            } else {
                notificationStatus.textContent = "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ï¼šãƒ–ãƒ­ãƒƒã‚¯ä¸­";
                requestNotificationBtn.style.display = 'none';
            }
        }
        
        requestNotificationBtn.addEventListener('click', () => {
            Notification.requestPermission().then(permission => {
                checkNotificationPermission();
            });
        });

        mainDatePicker.addEventListener('change', (e) => loadAllDataForDate(e.target.value));
        addPlanBtn.addEventListener('click', () => addTask(false));
        addUrgentBtn.addEventListener('click', () => addTask(true));
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        completeBtn.addEventListener('click', () => changeStatus('completed'));
        cancelBtn.addEventListener('click', () => changeStatus('canceled'));
        exportPlanBtn.addEventListener('click', () => exportCsv('plan'));
        exportå®Ÿç¸¾Btn.addEventListener('click', () => exportCsv('å®Ÿç¸¾'));
        planList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-plan-btn')) {
                const taskItem = e.target.closest('.task-item');
                const taskId = taskItem.dataset.id;
                if (confirm(`è¨ˆç”»ã‚¿ã‚¹ã‚¯ã€Œ${taskItem.querySelector('.task-text').textContent}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    await taskCollection.doc(taskId).delete();
                }
            }
        });
        
        mainDatePicker.value = new Date().toISOString().split('T')[0];
        setupDragAndDrop();
        if (auth.currentUser) {
            loadAllDataForDate(mainDatePicker.value);
        } else {
            render();
        }
    });
</script>
</body>
</html>
