<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間管理＆集中力向上ダッシュボード</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header,
        .data-management {
            grid-column: 1 / -1;
            text-align: center;
        }
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }

        .priority-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .matrix-quadrant {
            min-height: 120px;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            transition: transform 0.2s;
            text-align: left;
        }

        .matrix-quadrant:hover {
            transform: translateY(-2px);
        }

        .urgent-important {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }

        .important-not-urgent {
            background: linear-gradient(135deg, #2ed573, #1dd1a1);
            color: white;
        }

        .urgent-not-important {
            background: linear-gradient(135deg, #ffa502, #ff9500);
            color: white;
        }

        .not-urgent-not-important {
            background: linear-gradient(135deg, #747d8c, #57606f);
            color: white;
        }

        .quadrant-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .task-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .task-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .task-list {
            list-style: none;
            margin-top: 10px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
        }

        .pomodoro-timer {
            text-align: center;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
         .btn-warning {
            background: linear-gradient(45deg, #f0ad4e, #ec971f);
            color: white;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        /* ★追加: アクションボタン用のスタイル */
        .btn-success {
            background: linear-gradient(45deg, #2ed573, #1dd1a1);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-info {
            background: linear-gradient(45deg, #5bc0de, #31b0d5);
            color: white;
        }
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }


        .focus-mode {
            text-align: center;
        }

        .focus-status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .daily-goals {
            margin-top: 20px;
            text-align: left;
        }

        .goal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .goal-list {
            list-style: none;
        }

        .goal-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .goal-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .checkbox {
            margin-right: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .time-select,
        input[type="date"].time-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            color: #333;
        }

        .time-select:focus,
        input[type="date"].time-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-select:hover,
        input[type="date"].time-select:hover {
            border-color: #667eea;
        }

        .data-management-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            text-align: left;
        }
        .data-management-controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .data-management-controls label {
            font-weight: bold;
            color: #333;
        }
        .data-management .section-title {
            justify-content: center;
        }

        /* 視覚的通知用のスタイル */
        #visual-notification {
            display: none; /* 初期状態は非表示 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #visual-notification-content {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            font-size: 22px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 90%;
        }

        #visual-notification-content p {
            margin-bottom: 25px;
            font-weight: bold;
            line-height: 1.5;
        }
        /* ★変更: ボタンコンテナとボタンのスタイル */
        #visual-notification-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap; /* 小画面で折り返す */
        }
        #visual-notification-actions button,
        #visual-notification-content button#close-visual-notification { /* 閉じるボタンも統一感を出す */
            padding: 10px 20px; /* 少し小さめに調整 */
            border: none;
            border-radius: 20px;
            /* background-color: rgba(255,255,255,0.8); */ /* 個別のボタンスタイルで上書き */
            color: white; /* テキスト色は白を基本に */
            font-size: 15px; /* 少し小さめに調整 */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-weight: bold;
        }
        /* 閉じるボタンの個別スタイル */
        #close-visual-notification {
            background: linear-gradient(45deg, #747d8c, #57606f); /* グレー系 */
            margin-top: 15px; /* アクションボタン群との間に少しマージン */
        }
        #close-visual-notification:hover {
            transform: translateY(-1px);
            background: linear-gradient(45deg, #57606f, #4a505a);
        }
        #visual-notification-actions button:hover {
            transform: translateY(-2px);
        }


        .visible {
            display: flex !important;
        }

        @keyframes blink-alarm-bg {
            0%, 100% { background-color: #ff7e5f; }
            50% { background-color: #feb47b; }
        }
        #visual-notification-content.blinking {
             animation: blink-alarm-bg 1s infinite;
        }


        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .data-management-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .data-management-controls > div {
                justify-content: center;
            }
            #visual-notification-content {
                font-size: 18px;
                padding: 20px 30px;
            }
            #visual-notification-content p {
                margin-bottom: 20px;
            }
            #visual-notification-actions {
                flex-direction: column; /* スマホでは縦積み */
                gap: 10px;
            }
            #visual-notification-actions button,
            #close-visual-notification {
                width: 100%; /* ボタン幅を広げる */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card header">
            <h1>🎯 時間管理＆集中力向上ダッシュボード</h1>
            <p>タスク優先順位付け + ポモドーロテクニック</p>
        </div>

        <div class="card data-management">
            <h2 class="section-title">⚙️ データ管理</h2>
            <div class="data-management-controls">
                <div>
                    <label for="work-date">作業日:</label>
                    <input type="date" id="work-date" class="time-select">
                </div>
                <div>
                    <button class="btn btn-primary" id="export-csv-btn">実績をCSVで出力</button>
                    <button class="btn btn-warning" id="reset-all-btn" style="margin-left: 10px;">全データリセット</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">📊 アイゼンハワーマトリックス</h2>
            <div class="priority-matrix">
                <div class="matrix-quadrant urgent-important">
                    <div class="quadrant-title">🔥 緊急 & 重要</div>
                    <input type="text" class="task-input" placeholder="今すぐやるべきタスク" data-quadrant="urgent-important">
                    <ul class="task-list" id="urgent-important-list"></ul>
                </div>

                <div class="matrix-quadrant important-not-urgent">
                    <div class="quadrant-title">⭐ 重要 & 非緊急</div>
                    <input type="text" class="task-input" placeholder="計画的に取り組むタスク" data-quadrant="important-not-urgent">
                    <ul class="task-list" id="important-not-urgent-list"></ul>
                </div>

                <div class="matrix-quadrant urgent-not-important">
                    <div class="quadrant-title">⚡ 緊急 & 非重要</div>
                    <input type="text" class="task-input" placeholder="委譲できるタスク" data-quadrant="urgent-not-important">
                    <ul class="task-list" id="urgent-not-important-list"></ul>
                </div>

                <div class="matrix-quadrant not-urgent-not-important">
                    <div class="quadrant-title">❌ 非緊急 & 非重要</div>
                    <input type="text" class="task-input" placeholder="削除できるタスク" data-quadrant="not-urgent-not-important">
                    <ul class="task-list" id="not-urgent-not-important-list"></ul>
                </div>
            </div>
        </div>

        <div class="card pomodoro-timer">
            <h2 class="section-title">🍅 ポモドーロタイマー</h2>
            <div class="timer-settings" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">作業時間</label>
                    <select id="work-time-select" class="time-select">
                        <option value="15">15分</option>
                        <option value="20">20分</option>
                        <option value="25" selected>25分</option>
                        <option value="30">30分</option>
                        <option value="45">45分</option>
                        <option value="60">60分</option>
                        <option value="0.1">テスト(6秒)</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">休憩時間</label>
                    <select id="break-time-select" class="time-select">
                        <option value="3">3分</option>
                        <option value="5" selected>5分</option>
                        <option value="10">10分</option>
                        <option value="15">15分</option>
                        <option value="0.05">テスト(3秒)</option>
                    </select>
                </div>
            </div>
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn">開始</button>
                <button class="btn btn-secondary" id="reset-btn">リセット</button>
            </div>
            <div class="focus-mode">
                <div class="focus-status" id="focus-status">集中セッション準備完了</div>
                <p id="timer-description">25分集中 → 5分休憩のサイクルで作業効率UP！</p>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">🎯 今日の目標</h2>
            <div class="daily-goals">
                <input type="text" class="goal-input" id="goal-input" placeholder="今日達成したい目標を入力">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="goal-list" id="goal-list"></ul>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">💡 集中力向上のコツ</h2>
            <div style="line-height: 1.6;">
                <p><strong>🏠 在宅勤務時：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>作業専用スペースを設ける</li>
                    <li>家族に作業時間を共有</li>
                    <li>適度な背景音楽を活用</li>
                </ul>

                <p><strong>🏢 オフィス勤務時：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ノイズキャンセリングイヤホン使用</li>
                    <li>会議の合間に5分休憩</li>
                    <li>同僚とのコミュニケーション時間を設定</li>
                </ul>

                <p><strong>🌟 共通のコツ：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>スマホを別の場所に置く</li>
                    <li>水分補給を忘れずに</li>
                    <li>1時間に1回は立ち上がる</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 視覚的通知用要素 -->
    <div id="visual-notification">
        <div id="visual-notification-content">
            <p id="visual-notification-message">時間です！</p>
            <!-- ★追加: アクションボタン用コンテナ -->
            <div id="visual-notification-actions">
                <!-- ボタンはJSで動的に生成・制御することも可能 -->
                <button id="complete-task-btn" class="btn btn-success">予定通り完了して休憩へ</button>
                <button id="extend-task-btn" class="btn btn-info">作業を延長</button>
            </div>
            <button id="close-visual-notification">閉じる (通知のみ)</button>
        </div>
    </div>

    <!-- 音声通知用 -->
    <audio id="notification-sound" preload="auto"></audio>

    <script>
        // グローバル変数
        let timer = null;
        let workTime = 25 * 60; // 秒単位
        let breakTime = 5 * 60; // 秒単位
        let timeLeft = workTime;
        let isRunning = false;
        let isWorkSession = true;
        let sessionEndTime = null;
        let pomodoroLog = [];

        // ★追加: 実績記録用変数
        let initialWorkDurationForLog;    // 現在の作業セッションの当初計画時間（ログ用）
        let accumulatedActualWorkDuration = 0; // 現在の作業セッションで実際に作業した累計時間（ログ用）
        let currentTimerSliceDuration = 0;   // 現在動いているタイマー区分の時間（作業、休憩、または延長分）

        // DOM要素を取得
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const focusStatus = document.getElementById('focus-status');
        const workTimeSelect = document.getElementById('work-time-select');
        const breakTimeSelect = document.getElementById('break-time-select');
        const timerDescription = document.getElementById('timer-description');
        const goalInput = document.getElementById('goal-input');
        const goalList = document.getElementById('goal-list');
        const progressFill = document.getElementById('progress-fill');
        const workDateInput = document.getElementById('work-date');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');

        // 通知関連のDOM要素
        const visualNotificationElement = document.getElementById('visual-notification');
        const visualNotificationMessageElement = document.getElementById('visual-notification-message');
        const closeVisualNotificationButton = document.getElementById('close-visual-notification');
        const notificationSound = document.getElementById('notification-sound');
        // ★追加: アクションボタン
        const completeTaskBtn = document.getElementById('complete-task-btn');
        const extendTaskBtn = document.getElementById('extend-task-btn');


        // 音声ファイルの設定 (ローカルの alarm.mp3 を想定。適宜変更してください)
        //notificationSound.src = 'alarm.mp3'; // 例: 'sounds/alarm.mp3' またはデスクトップなら 'alarm.mp3'
        notificationSound.src = 'Assorted_SE12-21.mp3';

        // notificationSound.src = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';


        // アイゼンハワーマトリックス機能
        document.addEventListener('DOMContentLoaded', function() {
            const taskInputs = document.querySelectorAll('.task-input');
            taskInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        addTaskToMatrix(this.value.trim(), this.dataset.quadrant);
                        this.value = '';
                    }
                });
            });
            if (workDateInput) workDateInput.valueAsDate = new Date();
        });

        function addTaskToMatrix(taskText, quadrant) {
            const list = document.getElementById(quadrant + '-list');
            if (!list) return;
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `<span>${taskText}</span><button class="delete-btn" onclick="this.parentElement.remove()">×</button>`;
            list.appendChild(li);
        }

        // 時間設定の変更を監視
        workTimeSelect.addEventListener('change', function() {
            workTime = parseFloat(this.value) * 60;
            if (isWorkSession && !isRunning) {
                timeLeft = workTime;
                updateDisplay();
            }
            updateDescription();
        });

        breakTimeSelect.addEventListener('change', function() {
            breakTime = parseFloat(this.value) * 60;
            if (!isWorkSession && !isRunning) {
                timeLeft = breakTime;
                updateDisplay();
            }
            updateDescription();
        });

        // --- 通知機能 ---
        async function requestNotificationPermission() { /* 変更なし */ }
        function showBrowserNotification(title, body) { /* 変更なし */ }
        function playSoundNotification() { /* 変更なし */ }

        // ★変更: 視覚通知の表示/非表示関数
        function showEndOfSessionAlert(message, showActionButtons = true) {
            visualNotificationMessageElement.innerHTML = message;
            const actionButtonsContainer = document.getElementById('visual-notification-actions');
            if (showActionButtons) {
                actionButtonsContainer.style.display = 'flex';
            } else {
                actionButtonsContainer.style.display = 'none'; // アクションボタンを隠す場合
            }
            visualNotificationElement.classList.add('visible');
            visualNotificationElement.querySelector('#visual-notification-content').classList.add('blinking');
        }

        function hideVisualNotification() {
            visualNotificationElement.classList.remove('visible');
            visualNotificationElement.querySelector('#visual-notification-content').classList.remove('blinking');
        }
        // --- 通知機能ここまで ---


        // タイマー機能
        function updateTimer() {
            if (sessionEndTime === null) {
                if (timer) clearInterval(timer);
                timer = null;
                return;
            }

            const now = Date.now();
            const remainingMilliseconds = sessionEndTime - now;

            if (remainingMilliseconds <= 0) {
                timeLeft = 0;
                updateDisplay();
                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = '開始'; // または次のセッション名

                // ★変更: タイマー終了時の処理
                playSoundNotification(); // 音声通知

                if (isWorkSession) {
                    accumulatedActualWorkDuration += currentTimerSliceDuration; // この区分の作業時間を加算
                    const message = '🕒 作業時間終了！<br>どうしますか？';
                    showBrowserNotification("作業時間終了！", "次のアクションを選択してください。");
                    showEndOfSessionAlert(message, true); // アクションボタン付きで表示
                    // 次のセッションへの自動移行はユーザーのアクション待ち
                } else { // 休憩セッション終了
                    addPomodoroLog('break', currentTimerSliceDuration, currentTimerSliceDuration, new Date()); // 休憩は計画通り
                    
                    focusStatus.textContent = '✨ 休憩完了！次の集中セッションの準備をしましょう';
                    focusStatus.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                    isWorkSession = true;
                    timeLeft = workTime; // 次の作業時間
                    currentTimerSliceDuration = workTime; // ★追加
                    initialWorkDurationForLog = workTime; // ★追加: 新しい作業セッションの計画時間
                    accumulatedActualWorkDuration = 0;    // ★追加: 新しい作業セッションの実績リセット
                    
                    const message = '✨ 休憩完了！<br>次の作業を始めましょう。';
                    showBrowserNotification("休憩終了！", "次の作業を開始できます。");
                    showEndOfSessionAlert(message, false); // アクションボタンなし、閉じるのみ
                    // 自動で閉じるタイマーをセットしても良い
                    setTimeout(hideVisualNotification, 5000); // 5秒後に自動で閉じる例
                    updateDisplay();
                    startBtn.textContent = '作業開始';
                }
                sessionEndTime = null;
            } else {
                timeLeft = Math.round(remainingMilliseconds / 1000);
                updateDisplay();
            }
        }

        function updateDisplay() { /* 変更なし */ }
        function updateDescription() { /* 変更なし */ }

        function startTimerInternal() { // ★変更: startBtnの処理をラップする内部関数
            isRunning = true;
            sessionEndTime = Date.now() + timeLeft * 1000;
            if(timer) clearInterval(timer);
            timer = setInterval(updateTimer, 1000);
            updateTimer(); // 即時更新
        }


        function startPomodoroSession() { // ★変更: startBtnのクリックイベントハンドラ
            if (!isRunning) {
                requestNotificationPermission().then(granted => {
                    // 通知許可状態に関わらずタイマーは開始
                    if (notificationSound.src && notificationSound.src !== window.location.href) {
                        notificationSound.load();
                    }

                    if (isWorkSession) {
                        startBtn.textContent = '一時停止';
                        focusStatus.textContent = '🔥 集中セッション中！';
                        focusStatus.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a52)';
                        if (accumulatedActualWorkDuration === 0) { // 新規の作業セッションの場合
                            initialWorkDurationForLog = parseFloat(workTimeSelect.value) * 60;
                        }
                        // timeLeft は既にセットされているか、延長時に再セットされる
                        currentTimerSliceDuration = timeLeft; // 現在のタイマー区分の時間を保持
                    } else { // 休憩セッション開始
                        startBtn.textContent = '一時停止';
                        focusStatus.textContent = '☕ 休憩中...';
                        focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                        timeLeft = parseFloat(breakTimeSelect.value) * 60;
                        currentTimerSliceDuration = timeLeft;
                    }
                    hideVisualNotification(); // 開始時に通知が出ていれば消す
                    startTimerInternal();
                });

            } else { // 一時停止処理
                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = '再開';
                focusStatus.textContent = '⏸️ タイマー一時停止中';
                focusStatus.style.background = 'linear-gradient(45deg, #747d8c, #57606f)';
            }
        }

        function resetPomodoroTimer() {
            clearInterval(timer);
            timer = null;
            isRunning = false;
            isWorkSession = true;
            workTime = parseFloat(workTimeSelect.value) * 60; // リセット時は選択値に戻す
            breakTime = parseFloat(breakTimeSelect.value) * 60;
            timeLeft = workTime;
            currentTimerSliceDuration = workTime; // ★追加
            accumulatedActualWorkDuration = 0; // ★追加
            initialWorkDurationForLog = workTime; // ★追加
            sessionEndTime = null;
            startBtn.textContent = '開始';
            focusStatus.textContent = '集中セッション準備完了';
            focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            updateDisplay();
            document.title = "時間管理＆集中力向上ダッシュボード";
            hideVisualNotification();
        }

        // イベントリスナー
        startBtn.addEventListener('click', startPomodoroSession);
        resetBtn.addEventListener('click', resetPomodoroTimer);
        closeVisualNotificationButton.addEventListener('click', () => {
             hideVisualNotification();
             // 「閉じる」だけの場合、次のアクションを促すためにボタンテキストを「開始」に戻すなどしても良い
             if (!isRunning && sessionEndTime === null) { // タイマーが完全に停止している場合
                if (isWorkSession) startBtn.textContent = "作業開始";
                else startBtn.textContent = "休憩開始";
             }
        });

        // ★追加: アクションボタンのイベントリスナー
        completeTaskBtn.addEventListener('click', () => {
            if (isWorkSession) {
                // accumulatedActualWorkDuration は既に updateTimer の終了時に更新済み
                addPomodoroLog('work', initialWorkDurationForLog, accumulatedActualWorkDuration, new Date());
            }
            hideVisualNotification();

            // 休憩セッションへ移行
            isWorkSession = false;
            timeLeft = parseFloat(breakTimeSelect.value) * 60;
            currentTimerSliceDuration = timeLeft; // ★追加
            updateDisplay();
            focusStatus.textContent = '☕ 休憩時間の準備ができました';
            focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            startBtn.textContent = '休憩開始';
        });

        extendTaskBtn.addEventListener('click', () => {
            if (isWorkSession) {
                hideVisualNotification();
                // 延長時間は現在の作業時間設定と同じとする
                const extensionDuration = parseFloat(workTimeSelect.value) * 60;
                timeLeft = extensionDuration;
                currentTimerSliceDuration = extensionDuration; // ★追加：延長区分の時間をセット
                
                focusStatus.textContent = '🔥 作業延長中！';
                startBtn.textContent = '一時停止';
                startTimerInternal(); // タイマーを再開
            }
        });


        // 今日の目標機能 (変更なし)
        goalInput.addEventListener('keypress', function(e) { /* ... */ });
        function addGoal(goalText) { /* ... */ }
        window.toggleGoalCompletion = function(checkbox) { /* ... */ }
        window.removeGoalItem = function(button) { /* ... */ }
        function updateProgress() { /* ... */ }

        // ★変更: ポモドーロログ記録機能
        function addPomodoroLog(type, plannedDurationInSeconds, actualDurationInSeconds, completedAtDate) {
            pomodoroLog.push({
                type: type,
                plannedDuration: plannedDurationInSeconds, // 計画時間 (秒)
                actualDuration: actualDurationInSeconds,   // 実績時間 (秒)
                completedAt: completedAtDate
            });
            // console.log("Log added:", pomodoroLog[pomodoroLog.length -1]); // デバッグ用
        }

        // 全データリセット機能 (変更なし)
        resetAllBtn.addEventListener('click', function() { /* ... */ });

        // ★変更: CSV出力機能
        exportCsvBtn.addEventListener('click', function() {
            let csvContent = "";
            const selectedDate = workDateInput.value ? new Date(workDateInput.value) : new Date();
            const formattedDate = selectedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            csvContent += `日付,"${formattedDate}"\n\n`;

            csvContent += "今日の目標:\n";
            const goals = goalList.querySelectorAll('.goal-item span');
            if (goals.length > 0) {
                goals.forEach(goal => {
                    csvContent += `"${goal.textContent.replace(/"/g, '""')}"\n`;
                });
            } else {
                csvContent += "(目標なし)\n";
            }
            csvContent += "\n";

            // CSVヘッダーの変更
            csvContent += "種別,タスク名,計画時間(分),実績時間(分),ステータス,差異(分),完了時刻(HH:MM:SS)\n";

            if (pomodoroLog.length > 0) {
                pomodoroLog.forEach(log => {
                    const typeDisplay = log.type === 'work' ? "ポモドーロ作業" : "ポモドーロ休憩";
                    const taskName = log.type === 'work' ? "(作業内容を手入力)" : "-"; // タスク名は手入力のまま
                    
                    const plannedMinutes = Math.round(log.plannedDuration / 60);
                    const actualMinutes = Math.round(log.actualDuration / 60);
                    const diffMinutes = actualMinutes - plannedMinutes;

                    let status = "";
                    let diffDisplay = "";

                    if (log.type === 'work') { // 作業ログの場合のみステータスと差異を計算
                        if (actualMinutes === plannedMinutes) {
                            status = "計画通り";
                            diffDisplay = "0";
                        } else if (actualMinutes < plannedMinutes) {
                            status = "計画前倒し";
                            diffDisplay = String(diffMinutes); // 例: -5 (5分早く終わった)
                        } else { // actualMinutes > plannedMinutes
                            status = "計画遅れ";
                            diffDisplay = String(diffMinutes); // 例: 10 (10分遅れた)
                        }
                    } else { // 休憩ログの場合は空欄
                        status = "-";
                        diffDisplay = "-";
                    }

                    const completedTime = log.completedAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    csvContent += `"${typeDisplay}","${taskName}","${plannedMinutes}","${actualMinutes}","${status}","${diffDisplay}","${completedTime}"\n`;
                });
            } else {
                csvContent += "(実績ログなし)\n";
            }

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `実績データ_${formattedDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("お使いのブラウザはCSVダウンロードに対応していません。");
            }
        });

        // 初期設定
        resetPomodoroTimer(); // 初期化時に変数を正しくセットするためにresetを呼ぶ
        // updateDisplay(); // resetPomodoroTimer内で呼ばれる
        // updateDescription(); // resetPomodoroTimer内で呼ばれる
        if (!notificationSound.src || notificationSound.src === window.location.href || notificationSound.src.endsWith('/null') || notificationSound.src === '') {
             console.warn("注意: 通知音の音声ファイルパスが <audio> タグの src 属性に設定されていないか、JavaScriptで正しく設定されていません。`notificationSound.src = 'alarm.mp3';` のような行を確認・編集してください。");
             // alert("警告: 通知音の音声ファイルが設定されていません。");
        }
    </script>
</body>
</html>
