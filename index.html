<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間管理＆集中力向上ダッシュボード</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header,
        .data-management {
            grid-column: 1 / -1;
            text-align: center;
        }
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }

        .priority-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .matrix-quadrant {
            min-height: 120px;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            transition: transform 0.2s;
            text-align: left;
        }

        .matrix-quadrant:hover {
            transform: translateY(-2px);
        }

        .urgent-important {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }

        .important-not-urgent {
            background: linear-gradient(135deg, #2ed573, #1dd1a1);
            color: white;
        }

        .urgent-not-important {
            background: linear-gradient(135deg, #ffa502, #ff9500);
            color: white;
        }

        .not-urgent-not-important {
            background: linear-gradient(135deg, #747d8c, #57606f);
            color: white;
        }

        .quadrant-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .task-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .task-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .task-list {
            list-style: none;
            margin-top: 10px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
        }

        .pomodoro-timer {
            text-align: center;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
         .btn-warning {
            background: linear-gradient(45deg, #f0ad4e, #ec971f);
            color: white;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .focus-mode {
            text-align: center;
        }

        .focus-status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .daily-goals {
            margin-top: 20px;
            text-align: left;
        }

        .goal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .goal-list {
            list-style: none;
        }

        .goal-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .goal-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .checkbox {
            margin-right: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .time-select,
        input[type="date"].time-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            color: #333;
        }

        .time-select:focus,
        input[type="date"].time-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-select:hover,
        input[type="date"].time-select:hover {
            border-color: #667eea;
        }

        .data-management-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            text-align: left;
        }
        .data-management-controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .data-management-controls label {
            font-weight: bold;
            color: #333;
        }
        .data-management .section-title {
            justify-content: center;
        }

        /* ★追加: 視覚的通知用のスタイル */
        #visual-notification {
            display: none; /* 初期状態は非表示 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* 半透明の黒背景 */
            z-index: 1000; /* 他の要素より手前に表示 */
            justify-content: center;
            align-items: center;
        }

        #visual-notification-content {
            background: linear-gradient(135deg, #ff7e5f, #feb47b); /* 暖色系で目立つように */
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            font-size: 22px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 90%;
        }

        #visual-notification-content p {
            margin-bottom: 25px;
            font-weight: bold;
            line-height: 1.5;
        }
        #visual-notification-content button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background-color: rgba(255,255,255,0.8);
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #visual-notification-content button:hover {
            background-color: white;
        }

        .visible {
            display: flex !important; /* 表示するときは flex で中央揃え */
        }

        /* 点滅アニメーションの例 (オプション) */
        @keyframes blink-alarm-bg {
            0%, 100% { background-color: #ff7e5f; } /* グラデーションの開始色 */
            50% { background-color: #feb47b; } /* グラデーションの終了色に近い明るい色 */
        }
        #visual-notification-content.blinking { /* 点滅させたい場合にこのクラスを付与 */
             animation: blink-alarm-bg 1s infinite;
        }


        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .data-management-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .data-management-controls > div {
                justify-content: center;
            }
            #visual-notification-content {
                font-size: 18px;
                padding: 20px 30px;
            }
            #visual-notification-content p {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card header">
            <h1>🎯 時間管理＆集中力向上ダッシュボード</h1>
            <p>タスク優先順位付け + ポモドーロテクニック</p>
        </div>

        <div class="card data-management">
            <h2 class="section-title">⚙️ データ管理</h2>
            <div class="data-management-controls">
                <div>
                    <label for="work-date">作業日:</label>
                    <input type="date" id="work-date" class="time-select">
                </div>
                <div>
                    <button class="btn btn-primary" id="export-csv-btn">実績をCSVで出力</button>
                    <button class="btn btn-warning" id="reset-all-btn" style="margin-left: 10px;">全データリセット</button>
                    <!-- ★追加(任意): ブラウザ通知許可ボタンをここに置く場合
                    <button class="btn btn-info" id="request-permission-btn" style="margin-left: 10px;">通知許可</button>
                    -->
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">📊 アイゼンハワーマトリックス</h2>
            <div class="priority-matrix">
                <div class="matrix-quadrant urgent-important">
                    <div class="quadrant-title">🔥 緊急 & 重要</div>
                    <input type="text" class="task-input" placeholder="今すぐやるべきタスク" data-quadrant="urgent-important">
                    <ul class="task-list" id="urgent-important-list"></ul>
                </div>

                <div class="matrix-quadrant important-not-urgent">
                    <div class="quadrant-title">⭐ 重要 & 非緊急</div>
                    <input type="text" class="task-input" placeholder="計画的に取り組むタスク" data-quadrant="important-not-urgent">
                    <ul class="task-list" id="important-not-urgent-list"></ul>
                </div>

                <div class="matrix-quadrant urgent-not-important">
                    <div class="quadrant-title">⚡ 緊急 & 非重要</div>
                    <input type="text" class="task-input" placeholder="委譲できるタスク" data-quadrant="urgent-not-important">
                    <ul class="task-list" id="urgent-not-important-list"></ul>
                </div>

                <div class="matrix-quadrant not-urgent-not-important">
                    <div class="quadrant-title">❌ 非緊急 & 非重要</div>
                    <input type="text" class="task-input" placeholder="削除できるタスク" data-quadrant="not-urgent-not-important">
                    <ul class="task-list" id="not-urgent-not-important-list"></ul>
                </div>
            </div>
        </div>

        <div class="card pomodoro-timer">
            <h2 class="section-title">🍅 ポモドーロタイマー</h2>
            <div class="timer-settings" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">作業時間</label>
                    <select id="work-time-select" class="time-select">
                        <option value="15">15分</option>
                        <option value="20">20分</option>
                        <option value="25" selected>25分</option>
                        <option value="30">30分</option>
                        <option value="45">45分</option>
                        <option value="60">60分</option>
                        <option value="0.1">テスト(6秒)</option> <!-- ★追加: テスト用 -->
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">休憩時間</label>
                    <select id="break-time-select" class="time-select">
                        <option value="3">3分</option>
                        <option value="5" selected>5分</option>
                        <option value="10">10分</option>
                        <option value="15">15分</option>
                        <option value="0.05">テスト(3秒)</option> <!-- ★追加: テスト用 -->
                    </select>
                </div>
            </div>
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn">開始</button>
                <button class="btn btn-secondary" id="reset-btn">リセット</button>
            </div>
            <div class="focus-mode">
                <div class="focus-status" id="focus-status">集中セッション準備完了</div>
                <p id="timer-description">25分集中 → 5分休憩のサイクルで作業効率UP！</p>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">🎯 今日の目標</h2>
            <div class="daily-goals">
                <input type="text" class="goal-input" id="goal-input" placeholder="今日達成したい目標を入力">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="goal-list" id="goal-list"></ul>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">💡 集中力向上のコツ</h2>
            <div style="line-height: 1.6;">
                <p><strong>🏠 在宅勤務時：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>作業専用スペースを設ける</li>
                    <li>家族に作業時間を共有</li>
                    <li>適度な背景音楽を活用</li>
                </ul>

                <p><strong>🏢 オフィス勤務時：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ノイズキャンセリングイヤホン使用</li>
                    <li>会議の合間に5分休憩</li>
                    <li>同僚とのコミュニケーション時間を設定</li>
                </ul>

                <p><strong>🌟 共通のコツ：</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>スマホを別の場所に置く</li>
                    <li>水分補給を忘れずに</li>
                    <li>1時間に1回は立ち上がる</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ★追加: 視覚的通知用要素 -->
    <div id="visual-notification">
        <div id="visual-notification-content">
            <p id="visual-notification-message">時間です！</p>
            <button id="close-visual-notification">閉じる</button>
        </div>
    </div>

    <!-- ★追加: 音声通知用 -->
    <!-- 【重要】src属性に音声ファイルのパスを指定するか、JSで設定してください。 -->
    <audio id="notification-sound" preload="auto"></audio>

    <script>
        // グローバル変数
        let timer = null;
        let workTime = 25 * 60;
        let breakTime = 5 * 60;
        let timeLeft = workTime;
        let isRunning = false;
        let isWorkSession = true;
        let sessionEndTime = null;
        let pomodoroLog = [];

        // DOM要素を取得
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const focusStatus = document.getElementById('focus-status');
        const workTimeSelect = document.getElementById('work-time-select');
        const breakTimeSelect = document.getElementById('break-time-select');
        const timerDescription = document.getElementById('timer-description');
        const goalInput = document.getElementById('goal-input');
        const goalList = document.getElementById('goal-list');
        const progressFill = document.getElementById('progress-fill');
        const workDateInput = document.getElementById('work-date');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');

        // ★追加: 通知関連のDOM要素
        const visualNotificationElement = document.getElementById('visual-notification');
        const visualNotificationMessageElement = document.getElementById('visual-notification-message');
        const closeVisualNotificationButton = document.getElementById('close-visual-notification');
        const notificationSound = document.getElementById('notification-sound');
        // const requestPermissionBtn = document.getElementById('request-permission-btn'); // もし専用ボタンを設置する場合

        // ★追加: 音声ファイルの設定 (適宜変更してください)
        // 例: notificationSound.src = 'sounds/alarm.mp3';
        // テスト用にフリーの音源を指定
        notificationSound.src = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';


        // アイゼンハワーマトリックス機能
        document.addEventListener('DOMContentLoaded', function() {
            const taskInputs = document.querySelectorAll('.task-input');

            taskInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        addTaskToMatrix(this.value.trim(), this.dataset.quadrant);
                        this.value = '';
                    }
                });
            });

            if (workDateInput) {
                workDateInput.valueAsDate = new Date();
            }
        });

        function addTaskToMatrix(taskText, quadrant) {
            const list = document.getElementById(quadrant + '-list');
            if (!list) return;
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <span>${taskText}</span>
                <button class="delete-btn" onclick="this.parentElement.remove()">×</button>
            `;
            list.appendChild(li);
        }

        // 時間設定の変更を監視
        workTimeSelect.addEventListener('change', function() {
            workTime = parseFloat(this.value) * 60; // parseFloatで小数点対応
            if (isWorkSession && !isRunning) {
                timeLeft = workTime;
                updateDisplay();
            }
            updateDescription();
        });

        breakTimeSelect.addEventListener('change', function() {
            breakTime = parseFloat(this.value) * 60; // parseFloatで小数点対応
            if (!isWorkSession && !isRunning) {
                timeLeft = breakTime;
                updateDisplay();
            }
            updateDescription();
        });

        // --- ★追加: 通知機能 ---
        /**
         * ブラウザ通知の許可を求める
         */
        async function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("このブラウザはデスクトップ通知をサポートしていません。");
                return false;
            }
            if (Notification.permission === "granted") {
                return true;
            }
            if (Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    return true;
                } else {
                    console.warn("通知が許可されませんでした。");
                    return false;
                }
            } else {
                console.warn("通知がブロックされています。ブラウザの設定で通知を許可してください。");
                return false;
            }
        }

        /**
         * ブラウザ通知を表示する
         * @param {string} title 通知のタイトル
         * @param {string} body 通知の本文
         */
        function showBrowserNotification(title, body) {
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/1005/1005110.png' // 例: トマトアイコン
                });
                notification.onclick = () => {
                    window.focus(); // 通知クリックでウィンドウをフォーカス
                };
            } else {
                console.log("ブラウザ通知の許可がないため表示できませんでした。");
            }
        }

        /**
         * 音声通知を再生する
         */
        function playSoundNotification() {
            if (notificationSound.src && notificationSound.src !== window.location.href) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(error => {
                    console.error("音声の再生に失敗しました:", error);
                    // ユーザー操作なしの自動再生制限に引っかかった可能性
                    // alert("音声の再生に失敗しました。ブラウザの設定やミュート状態を確認してください。");
                });
            } else {
                console.warn("通知音の音声ファイルが設定されていません。");
            }
        }

        /**
         * 視覚的通知を表示する
         * @param {string} message 表示するメッセージ (HTML可)
         * @param {boolean} blink 点滅させるか
         */
        function showVisualNotification(message, blink = true) {
            visualNotificationMessageElement.innerHTML = message;
            visualNotificationElement.classList.add('visible');
            if (blink) {
                visualNotificationElement.querySelector('#visual-notification-content').classList.add('blinking');
            }
        }

        /**
         * 視覚的通知を非表示にする
         */
        function hideVisualNotification() {
            visualNotificationElement.classList.remove('visible');
            visualNotificationElement.querySelector('#visual-notification-content').classList.remove('blinking');
        }
        // --- ★追加ここまで: 通知機能 ---


        // タイマー機能
        function updateTimer() {
            if (sessionEndTime === null) {
                if (timer) clearInterval(timer);
                timer = null;
                return;
            }

            const now = Date.now();
            const remainingMilliseconds = sessionEndTime - now;

            if (remainingMilliseconds <= 0) {
                timeLeft = 0;
                updateDisplay();

                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = '開始';

                const completedDuration = isWorkSession ? workTime : breakTime;
                addPomodoroLog(isWorkSession ? 'work' : 'break', completedDuration);

                // ★変更: 通知処理
                if (isWorkSession) {
                    const message = '🎉 集中セッション完了！<br>休憩時間です';
                    focusStatus.textContent = '🎉 集中セッション完了！休憩時間です';
                    focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                    isWorkSession = false;
                    timeLeft = breakTime;
                    // alert('集中セッション完了！休憩時間です'); // 元のalertはコメントアウト
                    showBrowserNotification("集中セッション完了！", "お疲れ様でした。休憩を取りましょう。");
                    playSoundNotification();
                    showVisualNotification(message);
                } else {
                    const message = '✨ 休憩完了！<br>次の集中セッションの準備をしましょう';
                    focusStatus.textContent = '✨ 休憩完了！次の集中セッションの準備をしましょう';
                    focusStatus.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                    isWorkSession = true;
                    timeLeft = workTime;
                    // alert('休憩終了！集中セッションを開始しましょう'); // 元のalertはコメントアウト
                    showBrowserNotification("休憩終了！", "集中セッションを再開しましょう。");
                    playSoundNotification();
                    showVisualNotification(message);
                }

                sessionEndTime = null;
                updateDisplay();
            } else {
                timeLeft = Math.round(remainingMilliseconds / 1000);
                updateDisplay();
            }
        }

        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = timeString;
            if (isRunning || timeLeft < (isWorkSession ? workTime : breakTime)) {
                 document.title = `${timeString} - ${isWorkSession ? "集中" : "休憩"} | 時間管理ダッシュボード`;
            } else {
                 document.title = "時間管理＆集中力向上ダッシュボード";
            }
        }

        function updateDescription() {
            const workMinutes = Math.floor(workTime / 60);
            const breakMinutes = Math.floor(breakTime / 60);
            timerDescription.textContent = `${workMinutes}分集中 → ${breakMinutes}分休憩のサイクルで作業効率UP！`;
        }

        function startTimer() {
            if (!isRunning) {
                // ★追加: タイマースタート時に通知許可を求める
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        console.log("ブラウザ通知が許可されました。");
                    } else {
                        console.log("ブラウザ通知は許可されませんでした。");
                    }
                    // 通知許可状態に関わらずタイマーは開始
                    // ★追加: 音声再生の準備 (ユーザーインタラクション起因にする)
                    if (notificationSound.src && notificationSound.src !== window.location.href) {
                        notificationSound.load(); // 念のためロード
                    }

                    isRunning = true;
                    startBtn.textContent = '一時停止';
                    focusStatus.textContent = isWorkSession ? '🔥 集中セッション中！' : '☕ 休憩中...';
                    focusStatus.style.background = isWorkSession ?
                        'linear-gradient(45deg, #ff6b6b, #ee5a52)' :
                        'linear-gradient(45deg, #4ecdc4, #44a08d)';

                    sessionEndTime = Date.now() + timeLeft * 1000;

                    if(timer) clearInterval(timer);
                    timer = setInterval(updateTimer, 1000);
                    updateTimer();
                });

            } else {
                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = '開始';
                focusStatus.textContent = '⏸️ タイマー一時停止中';
                focusStatus.style.background = 'linear-gradient(45deg, #747d8c, #57606f)';
            }
        }

        function resetPomodoroTimer() {
            clearInterval(timer);
            timer = null;
            isRunning = false;
            isWorkSession = true;
            timeLeft = workTime;
            sessionEndTime = null;
            startBtn.textContent = '開始';
            focusStatus.textContent = '集中セッション準備完了';
            focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            updateDisplay();
            document.title = "時間管理＆集中力向上ダッシュボード";
            hideVisualNotification(); // ★追加: リセット時に視覚通知も消す
        }

        // イベントリスナー
        startBtn.addEventListener('click', startTimer);
        resetBtn.addEventListener('click', resetPomodoroTimer);
        closeVisualNotificationButton.addEventListener('click', hideVisualNotification); // ★追加

        // もし専用の通知許可ボタンを設置した場合のリスナー
        // if (requestPermissionBtn) {
        //     requestPermissionBtn.addEventListener('click', () => {
        //         requestNotificationPermission().then(granted => {
        //             if (granted) alert("ブラウザ通知が許可されました。");
        //         });
        //     });
        // }


        // 今日の目標機能
        goalInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                addGoal(this.value.trim());
                this.value = '';
            }
        });

        function addGoal(goalText) {
            const li = document.createElement('li');
            li.className = 'goal-item';
            li.innerHTML = `
                <div>
                    <input type="checkbox" class="checkbox" onchange="toggleGoalCompletion(this)">
                    <span>${goalText}</span>
                </div>
                <button class="delete-btn" onclick="removeGoalItem(this)" style="color: #666;">×</button>
            `;
            goalList.appendChild(li);
            updateProgress();
        }

        window.toggleGoalCompletion = function(checkbox) {
            const goalItem = checkbox.closest('.goal-item');
            if (checkbox.checked) {
                goalItem.classList.add('completed');
            } else {
                goalItem.classList.remove('completed');
            }
            updateProgress();
        }

        window.removeGoalItem = function(button) {
            button.parentElement.remove();
            updateProgress();
        }

        function updateProgress() {
            const totalGoals = goalList.children.length;
            const completedGoals = goalList.querySelectorAll('.completed').length;
            const progress = totalGoals > 0 ? (completedGoals / totalGoals) * 100 : 0;
            progressFill.style.width = progress + '%';
        }

        // ポモドーロログ記録機能
        function addPomodoroLog(type, durationInSeconds) {
            pomodoroLog.push({
                type: type,
                duration: durationInSeconds,
                completedAt: new Date()
            });
        }

        // 全データリセット機能
        resetAllBtn.addEventListener('click', function() {
            if (confirm('すべてのタスク、目標、ポモドーロログをリセットしますか？この操作は元に戻せません。')) {
                document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                goalList.innerHTML = '';
                updateProgress();
                resetPomodoroTimer();
                pomodoroLog = [];
                if (workDateInput) {
                     workDateInput.valueAsDate = new Date();
                }
                alert('すべてのデータがリセットされました。');
            }
        });

        // CSV出力機能
        exportCsvBtn.addEventListener('click', function() {
            let csvContent = "";
            const selectedDate = workDateInput.value ? new Date(workDateInput.value) : new Date();
            const formattedDate = selectedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            csvContent += `日付,"${formattedDate}"\n\n`;

            csvContent += "今日の目標:\n";
            const goals = goalList.querySelectorAll('.goal-item span');
            if (goals.length > 0) {
                goals.forEach(goal => {
                    csvContent += `"${goal.textContent.replace(/"/g, '""')}"\n`;
                });
            } else {
                csvContent += "(目標なし)\n";
            }
            csvContent += "\n";

            csvContent += "種別,タスク名,実績(分),完了時刻(HH:MM:SS)\n";

            if (pomodoroLog.length > 0) {
                pomodoroLog.forEach(log => {
                    const typeDisplay = log.type === 'work' ? "ポモドーロ作業" : "ポモドーロ休憩";
                    const taskName = log.type === 'work' ? "(作業内容を手入力)" : "-";
                    const durationMinutes = Math.floor(log.duration / 60);
                    const completedTime = log.completedAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    csvContent += `"${typeDisplay}","${taskName}","${durationMinutes}","${completedTime}"\n`;
                });
            } else {
                csvContent += "(実績ログなし)\n";
            }

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `実績データ_${formattedDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("お使いのブラウザはCSVダウンロードに対応していません。");
            }
        });

        // 初期設定
        updateDisplay();
        updateDescription();
        if (!notificationSound.src || notificationSound.src === window.location.href) {
             console.warn("注意: 通知音の音声ファイルパスが <audio> タグの src 属性に設定されていないか、JavaScriptで正しく設定されていません。`notificationSound.src = '...'` の行を確認・編集してください。");
        }
    </script>
</body>
</html>
