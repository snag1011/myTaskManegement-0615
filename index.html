<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“ç®¡ç†ï¼†é›†ä¸­åŠ›å‘ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header,
        .data-management {
            grid-column: 1 / -1;
            text-align: center;
        }
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }

        .priority-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .matrix-quadrant {
            min-height: 120px;
            border-radius: 10px;
            padding: 15px;
            position: relative;
            transition: transform 0.2s;
            text-align: left;
        }

        .matrix-quadrant:hover {
            transform: translateY(-2px);
        }

        .urgent-important {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }

        .important-not-urgent {
            background: linear-gradient(135deg, #2ed573, #1dd1a1);
            color: white;
        }

        .urgent-not-important {
            background: linear-gradient(135deg, #ffa502, #ff9500);
            color: white;
        }

        .not-urgent-not-important {
            background: linear-gradient(135deg, #747d8c, #57606f);
            color: white;
        }

        .quadrant-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .task-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .task-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .task-list {
            list-style: none;
            margin-top: 10px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
        }

        .pomodoro-timer {
            text-align: center;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
         .btn-warning {
            background: linear-gradient(45deg, #f0ad4e, #ec971f);
            color: white;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .focus-mode {
            text-align: center;
        }

        .focus-status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .daily-goals {
            margin-top: 20px;
            text-align: left;
        }

        .goal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .goal-list {
            list-style: none;
        }

        .goal-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .goal-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .checkbox {
            margin-right: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .time-select,
        input[type="date"].time-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            color: #333;
        }

        .time-select:focus,
        input[type="date"].time-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-select:hover,
        input[type="date"].time-select:hover {
            border-color: #667eea;
        }

        .data-management-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            text-align: left;
        }
        .data-management-controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .data-management-controls label {
            font-weight: bold;
            color: #333;
        }
        .data-management .section-title {
            justify-content: center;
        }

        /* â˜…è¿½åŠ : è¦–è¦šçš„é€šçŸ¥ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #visual-notification {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* åŠé€æ˜ã®é»’èƒŒæ™¯ */
            z-index: 1000; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
            justify-content: center;
            align-items: center;
        }

        #visual-notification-content {
            background: linear-gradient(135deg, #ff7e5f, #feb47b); /* æš–è‰²ç³»ã§ç›®ç«‹ã¤ã‚ˆã†ã« */
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            font-size: 22px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 90%;
        }

        #visual-notification-content p {
            margin-bottom: 25px;
            font-weight: bold;
            line-height: 1.5;
        }
        #visual-notification-content button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background-color: rgba(255,255,255,0.8);
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #visual-notification-content button:hover {
            background-color: white;
        }

        .visible {
            display: flex !important; /* è¡¨ç¤ºã™ã‚‹ã¨ãã¯ flex ã§ä¸­å¤®æƒãˆ */
        }

        /* ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) */
        @keyframes blink-alarm-bg {
            0%, 100% { background-color: #ff7e5f; } /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹è‰² */
            50% { background-color: #feb47b; } /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†è‰²ã«è¿‘ã„æ˜ã‚‹ã„è‰² */
        }
        #visual-notification-content.blinking { /* ç‚¹æ»…ã•ã›ãŸã„å ´åˆã«ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ */
             animation: blink-alarm-bg 1s infinite;
        }


        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .data-management-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .data-management-controls > div {
                justify-content: center;
            }
            #visual-notification-content {
                font-size: 18px;
                padding: 20px 30px;
            }
            #visual-notification-content p {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card header">
            <h1>ğŸ¯ æ™‚é–“ç®¡ç†ï¼†é›†ä¸­åŠ›å‘ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>ã‚¿ã‚¹ã‚¯å„ªå…ˆé †ä½ä»˜ã‘ + ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</p>
        </div>

        <div class="card data-management">
            <h2 class="section-title">âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <div class="data-management-controls">
                <div>
                    <label for="work-date">ä½œæ¥­æ—¥:</label>
                    <input type="date" id="work-date" class="time-select">
                </div>
                <div>
                    <button class="btn btn-primary" id="export-csv-btn">å®Ÿç¸¾ã‚’CSVã§å‡ºåŠ›</button>
                    <button class="btn btn-warning" id="reset-all-btn" style="margin-left: 10px;">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                    <!-- â˜…è¿½åŠ (ä»»æ„): ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã‚’ã“ã“ã«ç½®ãå ´åˆ
                    <button class="btn btn-info" id="request-permission-btn" style="margin-left: 10px;">é€šçŸ¥è¨±å¯</button>
                    -->
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">ğŸ“Š ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼ãƒãƒˆãƒªãƒƒã‚¯ã‚¹</h2>
            <div class="priority-matrix">
                <div class="matrix-quadrant urgent-important">
                    <div class="quadrant-title">ğŸ”¥ ç·Šæ€¥ & é‡è¦</div>
                    <input type="text" class="task-input" placeholder="ä»Šã™ãã‚„ã‚‹ã¹ãã‚¿ã‚¹ã‚¯" data-quadrant="urgent-important">
                    <ul class="task-list" id="urgent-important-list"></ul>
                </div>

                <div class="matrix-quadrant important-not-urgent">
                    <div class="quadrant-title">â­ é‡è¦ & éç·Šæ€¥</div>
                    <input type="text" class="task-input" placeholder="è¨ˆç”»çš„ã«å–ã‚Šçµ„ã‚€ã‚¿ã‚¹ã‚¯" data-quadrant="important-not-urgent">
                    <ul class="task-list" id="important-not-urgent-list"></ul>
                </div>

                <div class="matrix-quadrant urgent-not-important">
                    <div class="quadrant-title">âš¡ ç·Šæ€¥ & éé‡è¦</div>
                    <input type="text" class="task-input" placeholder="å§”è­²ã§ãã‚‹ã‚¿ã‚¹ã‚¯" data-quadrant="urgent-not-important">
                    <ul class="task-list" id="urgent-not-important-list"></ul>
                </div>

                <div class="matrix-quadrant not-urgent-not-important">
                    <div class="quadrant-title">âŒ éç·Šæ€¥ & éé‡è¦</div>
                    <input type="text" class="task-input" placeholder="å‰Šé™¤ã§ãã‚‹ã‚¿ã‚¹ã‚¯" data-quadrant="not-urgent-not-important">
                    <ul class="task-list" id="not-urgent-not-important-list"></ul>
                </div>
            </div>
        </div>

        <div class="card pomodoro-timer">
            <h2 class="section-title">ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</h2>
            <div class="timer-settings" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä½œæ¥­æ™‚é–“</label>
                    <select id="work-time-select" class="time-select">
                        <option value="15">15åˆ†</option>
                        <option value="20">20åˆ†</option>
                        <option value="25" selected>25åˆ†</option>
                        <option value="30">30åˆ†</option>
                        <option value="45">45åˆ†</option>
                        <option value="60">60åˆ†</option>
                        <option value="0.1">ãƒ†ã‚¹ãƒˆ(6ç§’)</option> <!-- â˜…è¿½åŠ : ãƒ†ã‚¹ãƒˆç”¨ -->
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¼‘æ†©æ™‚é–“</label>
                    <select id="break-time-select" class="time-select">
                        <option value="3">3åˆ†</option>
                        <option value="5" selected>5åˆ†</option>
                        <option value="10">10åˆ†</option>
                        <option value="15">15åˆ†</option>
                        <option value="0.05">ãƒ†ã‚¹ãƒˆ(3ç§’)</option> <!-- â˜…è¿½åŠ : ãƒ†ã‚¹ãƒˆç”¨ -->
                    </select>
                </div>
            </div>
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn">é–‹å§‹</button>
                <button class="btn btn-secondary" id="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="focus-mode">
                <div class="focus-status" id="focus-status">é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†</div>
                <p id="timer-description">25åˆ†é›†ä¸­ â†’ 5åˆ†ä¼‘æ†©ã®ã‚µã‚¤ã‚¯ãƒ«ã§ä½œæ¥­åŠ¹ç‡UPï¼</p>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">ğŸ¯ ä»Šæ—¥ã®ç›®æ¨™</h2>
            <div class="daily-goals">
                <input type="text" class="goal-input" id="goal-input" placeholder="ä»Šæ—¥é”æˆã—ãŸã„ç›®æ¨™ã‚’å…¥åŠ›">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <ul class="goal-list" id="goal-list"></ul>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">ğŸ’¡ é›†ä¸­åŠ›å‘ä¸Šã®ã‚³ãƒ„</h2>
            <div style="line-height: 1.6;">
                <p><strong>ğŸ  åœ¨å®…å‹¤å‹™æ™‚ï¼š</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ä½œæ¥­å°‚ç”¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨­ã‘ã‚‹</li>
                    <li>å®¶æ—ã«ä½œæ¥­æ™‚é–“ã‚’å…±æœ‰</li>
                    <li>é©åº¦ãªèƒŒæ™¯éŸ³æ¥½ã‚’æ´»ç”¨</li>
                </ul>

                <p><strong>ğŸ¢ ã‚ªãƒ•ã‚£ã‚¹å‹¤å‹™æ™‚ï¼š</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°ã‚¤ãƒ¤ãƒ›ãƒ³ä½¿ç”¨</li>
                    <li>ä¼šè­°ã®åˆé–“ã«5åˆ†ä¼‘æ†©</li>
                    <li>åŒåƒšã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’è¨­å®š</li>
                </ul>

                <p><strong>ğŸŒŸ å…±é€šã®ã‚³ãƒ„ï¼š</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ã‚¹ãƒãƒ›ã‚’åˆ¥ã®å ´æ‰€ã«ç½®ã</li>
                    <li>æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«</li>
                    <li>1æ™‚é–“ã«1å›ã¯ç«‹ã¡ä¸ŠãŒã‚‹</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- â˜…è¿½åŠ : è¦–è¦šçš„é€šçŸ¥ç”¨è¦ç´  -->
    <div id="visual-notification">
        <div id="visual-notification-content">
            <p id="visual-notification-message">æ™‚é–“ã§ã™ï¼</p>
            <button id="close-visual-notification">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- â˜…è¿½åŠ : éŸ³å£°é€šçŸ¥ç”¨ -->
    <!-- ã€é‡è¦ã€‘srcå±æ€§ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã‹ã€JSã§è¨­å®šã—ã¦ãã ã•ã„ã€‚ -->
    <audio id="notification-sound" preload="auto"></audio>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let timer = null;
        let workTime = 25 * 60;
        let breakTime = 5 * 60;
        let timeLeft = workTime;
        let isRunning = false;
        let isWorkSession = true;
        let sessionEndTime = null;
        let pomodoroLog = [];

        // DOMè¦ç´ ã‚’å–å¾—
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const focusStatus = document.getElementById('focus-status');
        const workTimeSelect = document.getElementById('work-time-select');
        const breakTimeSelect = document.getElementById('break-time-select');
        const timerDescription = document.getElementById('timer-description');
        const goalInput = document.getElementById('goal-input');
        const goalList = document.getElementById('goal-list');
        const progressFill = document.getElementById('progress-fill');
        const workDateInput = document.getElementById('work-date');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');

        // â˜…è¿½åŠ : é€šçŸ¥é–¢é€£ã®DOMè¦ç´ 
        const visualNotificationElement = document.getElementById('visual-notification');
        const visualNotificationMessageElement = document.getElementById('visual-notification-message');
        const closeVisualNotificationButton = document.getElementById('close-visual-notification');
        const notificationSound = document.getElementById('notification-sound');
        // const requestPermissionBtn = document.getElementById('request-permission-btn'); // ã‚‚ã—å°‚ç”¨ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã™ã‚‹å ´åˆ

        // â˜…è¿½åŠ : éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š (é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„)
        // ä¾‹: notificationSound.src = 'sounds/alarm.mp3';
        // ãƒ†ã‚¹ãƒˆç”¨ã«ãƒ•ãƒªãƒ¼ã®éŸ³æºã‚’æŒ‡å®š
        notificationSound.src = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';


        // ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æ©Ÿèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const taskInputs = document.querySelectorAll('.task-input');

            taskInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        addTaskToMatrix(this.value.trim(), this.dataset.quadrant);
                        this.value = '';
                    }
                });
            });

            if (workDateInput) {
                workDateInput.valueAsDate = new Date();
            }
        });

        function addTaskToMatrix(taskText, quadrant) {
            const list = document.getElementById(quadrant + '-list');
            if (!list) return;
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <span>${taskText}</span>
                <button class="delete-btn" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(li);
        }

        // æ™‚é–“è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
        workTimeSelect.addEventListener('change', function() {
            workTime = parseFloat(this.value) * 60; // parseFloatã§å°æ•°ç‚¹å¯¾å¿œ
            if (isWorkSession && !isRunning) {
                timeLeft = workTime;
                updateDisplay();
            }
            updateDescription();
        });

        breakTimeSelect.addEventListener('change', function() {
            breakTime = parseFloat(this.value) * 60; // parseFloatã§å°æ•°ç‚¹å¯¾å¿œ
            if (!isWorkSession && !isRunning) {
                timeLeft = breakTime;
                updateDisplay();
            }
            updateDescription();
        });

        // --- â˜…è¿½åŠ : é€šçŸ¥æ©Ÿèƒ½ ---
        /**
         * ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®è¨±å¯ã‚’æ±‚ã‚ã‚‹
         */
        async function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return false;
            }
            if (Notification.permission === "granted") {
                return true;
            }
            if (Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    return true;
                } else {
                    console.warn("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                    return false;
                }
            } else {
                console.warn("é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                return false;
            }
        }

        /**
         * ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} title é€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«
         * @param {string} body é€šçŸ¥ã®æœ¬æ–‡
         */
        function showBrowserNotification(title, body) {
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/1005/1005110.png' // ä¾‹: ãƒˆãƒãƒˆã‚¢ã‚¤ã‚³ãƒ³
                });
                notification.onclick = () => {
                    window.focus(); // é€šçŸ¥ã‚¯ãƒªãƒƒã‚¯ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                };
            } else {
                console.log("ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®è¨±å¯ãŒãªã„ãŸã‚è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        }

        /**
         * éŸ³å£°é€šçŸ¥ã‚’å†ç”Ÿã™ã‚‹
         */
        function playSoundNotification() {
            if (notificationSound.src && notificationSound.src !== window.location.href) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(error => {
                    console.error("éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãªã—ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã«å¼•ã£ã‹ã‹ã£ãŸå¯èƒ½æ€§
                    // alert("éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚„ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                });
            } else {
                console.warn("é€šçŸ¥éŸ³ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            }
        }

        /**
         * è¦–è¦šçš„é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {string} message è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (HTMLå¯)
         * @param {boolean} blink ç‚¹æ»…ã•ã›ã‚‹ã‹
         */
        function showVisualNotification(message, blink = true) {
            visualNotificationMessageElement.innerHTML = message;
            visualNotificationElement.classList.add('visible');
            if (blink) {
                visualNotificationElement.querySelector('#visual-notification-content').classList.add('blinking');
            }
        }

        /**
         * è¦–è¦šçš„é€šçŸ¥ã‚’éè¡¨ç¤ºã«ã™ã‚‹
         */
        function hideVisualNotification() {
            visualNotificationElement.classList.remove('visible');
            visualNotificationElement.querySelector('#visual-notification-content').classList.remove('blinking');
        }
        // --- â˜…è¿½åŠ ã“ã“ã¾ã§: é€šçŸ¥æ©Ÿèƒ½ ---


        // ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
        function updateTimer() {
            if (sessionEndTime === null) {
                if (timer) clearInterval(timer);
                timer = null;
                return;
            }

            const now = Date.now();
            const remainingMilliseconds = sessionEndTime - now;

            if (remainingMilliseconds <= 0) {
                timeLeft = 0;
                updateDisplay();

                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = 'é–‹å§‹';

                const completedDuration = isWorkSession ? workTime : breakTime;
                addPomodoroLog(isWorkSession ? 'work' : 'break', completedDuration);

                // â˜…å¤‰æ›´: é€šçŸ¥å‡¦ç†
                if (isWorkSession) {
                    const message = 'ğŸ‰ é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼<br>ä¼‘æ†©æ™‚é–“ã§ã™';
                    focusStatus.textContent = 'ğŸ‰ é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼ä¼‘æ†©æ™‚é–“ã§ã™';
                    focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                    isWorkSession = false;
                    timeLeft = breakTime;
                    // alert('é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼ä¼‘æ†©æ™‚é–“ã§ã™'); // å…ƒã®alertã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                    showBrowserNotification("é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ä¼‘æ†©ã‚’å–ã‚Šã¾ã—ã‚‡ã†ã€‚");
                    playSoundNotification();
                    showVisualNotification(message);
                } else {
                    const message = 'âœ¨ ä¼‘æ†©å®Œäº†ï¼<br>æ¬¡ã®é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†';
                    focusStatus.textContent = 'âœ¨ ä¼‘æ†©å®Œäº†ï¼æ¬¡ã®é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†';
                    focusStatus.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                    isWorkSession = true;
                    timeLeft = workTime;
                    // alert('ä¼‘æ†©çµ‚äº†ï¼é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†'); // å…ƒã®alertã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                    showBrowserNotification("ä¼‘æ†©çµ‚äº†ï¼", "é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹ã—ã¾ã—ã‚‡ã†ã€‚");
                    playSoundNotification();
                    showVisualNotification(message);
                }

                sessionEndTime = null;
                updateDisplay();
            } else {
                timeLeft = Math.round(remainingMilliseconds / 1000);
                updateDisplay();
            }
        }

        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = timeString;
            if (isRunning || timeLeft < (isWorkSession ? workTime : breakTime)) {
                 document.title = `${timeString} - ${isWorkSession ? "é›†ä¸­" : "ä¼‘æ†©"} | æ™‚é–“ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰`;
            } else {
                 document.title = "æ™‚é–“ç®¡ç†ï¼†é›†ä¸­åŠ›å‘ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰";
            }
        }

        function updateDescription() {
            const workMinutes = Math.floor(workTime / 60);
            const breakMinutes = Math.floor(breakTime / 60);
            timerDescription.textContent = `${workMinutes}åˆ†é›†ä¸­ â†’ ${breakMinutes}åˆ†ä¼‘æ†©ã®ã‚µã‚¤ã‚¯ãƒ«ã§ä½œæ¥­åŠ¹ç‡UPï¼`;
        }

        function startTimer() {
            if (!isRunning) {
                // â˜…è¿½åŠ : ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«é€šçŸ¥è¨±å¯ã‚’æ±‚ã‚ã‚‹
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        console.log("ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
                    } else {
                        console.log("ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                    // é€šçŸ¥è¨±å¯çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšã‚¿ã‚¤ãƒãƒ¼ã¯é–‹å§‹
                    // â˜…è¿½åŠ : éŸ³å£°å†ç”Ÿã®æº–å‚™ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³èµ·å› ã«ã™ã‚‹)
                    if (notificationSound.src && notificationSound.src !== window.location.href) {
                        notificationSound.load(); // å¿µã®ãŸã‚ãƒ­ãƒ¼ãƒ‰
                    }

                    isRunning = true;
                    startBtn.textContent = 'ä¸€æ™‚åœæ­¢';
                    focusStatus.textContent = isWorkSession ? 'ğŸ”¥ é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼' : 'â˜• ä¼‘æ†©ä¸­...';
                    focusStatus.style.background = isWorkSession ?
                        'linear-gradient(45deg, #ff6b6b, #ee5a52)' :
                        'linear-gradient(45deg, #4ecdc4, #44a08d)';

                    sessionEndTime = Date.now() + timeLeft * 1000;

                    if(timer) clearInterval(timer);
                    timer = setInterval(updateTimer, 1000);
                    updateTimer();
                });

            } else {
                clearInterval(timer);
                timer = null;
                isRunning = false;
                startBtn.textContent = 'é–‹å§‹';
                focusStatus.textContent = 'â¸ï¸ ã‚¿ã‚¤ãƒãƒ¼ä¸€æ™‚åœæ­¢ä¸­';
                focusStatus.style.background = 'linear-gradient(45deg, #747d8c, #57606f)';
            }
        }

        function resetPomodoroTimer() {
            clearInterval(timer);
            timer = null;
            isRunning = false;
            isWorkSession = true;
            timeLeft = workTime;
            sessionEndTime = null;
            startBtn.textContent = 'é–‹å§‹';
            focusStatus.textContent = 'é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†';
            focusStatus.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            updateDisplay();
            document.title = "æ™‚é–“ç®¡ç†ï¼†é›†ä¸­åŠ›å‘ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰";
            hideVisualNotification(); // â˜…è¿½åŠ : ãƒªã‚»ãƒƒãƒˆæ™‚ã«è¦–è¦šé€šçŸ¥ã‚‚æ¶ˆã™
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        startBtn.addEventListener('click', startTimer);
        resetBtn.addEventListener('click', resetPomodoroTimer);
        closeVisualNotificationButton.addEventListener('click', hideVisualNotification); // â˜…è¿½åŠ 

        // ã‚‚ã—å°‚ç”¨ã®é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã—ãŸå ´åˆã®ãƒªã‚¹ãƒŠãƒ¼
        // if (requestPermissionBtn) {
        //     requestPermissionBtn.addEventListener('click', () => {
        //         requestNotificationPermission().then(granted => {
        //             if (granted) alert("ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
        //         });
        //     });
        // }


        // ä»Šæ—¥ã®ç›®æ¨™æ©Ÿèƒ½
        goalInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                addGoal(this.value.trim());
                this.value = '';
            }
        });

        function addGoal(goalText) {
            const li = document.createElement('li');
            li.className = 'goal-item';
            li.innerHTML = `
                <div>
                    <input type="checkbox" class="checkbox" onchange="toggleGoalCompletion(this)">
                    <span>${goalText}</span>
                </div>
                <button class="delete-btn" onclick="removeGoalItem(this)" style="color: #666;">Ã—</button>
            `;
            goalList.appendChild(li);
            updateProgress();
        }

        window.toggleGoalCompletion = function(checkbox) {
            const goalItem = checkbox.closest('.goal-item');
            if (checkbox.checked) {
                goalItem.classList.add('completed');
            } else {
                goalItem.classList.remove('completed');
            }
            updateProgress();
        }

        window.removeGoalItem = function(button) {
            button.parentElement.remove();
            updateProgress();
        }

        function updateProgress() {
            const totalGoals = goalList.children.length;
            const completedGoals = goalList.querySelectorAll('.completed').length;
            const progress = totalGoals > 0 ? (completedGoals / totalGoals) * 100 : 0;
            progressFill.style.width = progress + '%';
        }

        // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ­ã‚°è¨˜éŒ²æ©Ÿèƒ½
        function addPomodoroLog(type, durationInSeconds) {
            pomodoroLog.push({
                type: type,
                duration: durationInSeconds,
                completedAt: new Date()
            });
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        resetAllBtn.addEventListener('click', function() {
            if (confirm('ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã€ç›®æ¨™ã€ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                goalList.innerHTML = '';
                updateProgress();
                resetPomodoroTimer();
                pomodoroLog = [];
                if (workDateInput) {
                     workDateInput.valueAsDate = new Date();
                }
                alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            }
        });

        // CSVå‡ºåŠ›æ©Ÿèƒ½
        exportCsvBtn.addEventListener('click', function() {
            let csvContent = "";
            const selectedDate = workDateInput.value ? new Date(workDateInput.value) : new Date();
            const formattedDate = selectedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            csvContent += `æ—¥ä»˜,"${formattedDate}"\n\n`;

            csvContent += "ä»Šæ—¥ã®ç›®æ¨™:\n";
            const goals = goalList.querySelectorAll('.goal-item span');
            if (goals.length > 0) {
                goals.forEach(goal => {
                    csvContent += `"${goal.textContent.replace(/"/g, '""')}"\n`;
                });
            } else {
                csvContent += "(ç›®æ¨™ãªã—)\n";
            }
            csvContent += "\n";

            csvContent += "ç¨®åˆ¥,ã‚¿ã‚¹ã‚¯å,å®Ÿç¸¾(åˆ†),å®Œäº†æ™‚åˆ»(HH:MM:SS)\n";

            if (pomodoroLog.length > 0) {
                pomodoroLog.forEach(log => {
                    const typeDisplay = log.type === 'work' ? "ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ä½œæ¥­" : "ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ä¼‘æ†©";
                    const taskName = log.type === 'work' ? "(ä½œæ¥­å†…å®¹ã‚’æ‰‹å…¥åŠ›)" : "-";
                    const durationMinutes = Math.floor(log.duration / 60);
                    const completedTime = log.completedAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    csvContent += `"${typeDisplay}","${taskName}","${durationMinutes}","${completedTime}"\n`;
                });
            } else {
                csvContent += "(å®Ÿç¸¾ãƒ­ã‚°ãªã—)\n";
            }

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿_${formattedDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            }
        });

        // åˆæœŸè¨­å®š
        updateDisplay();
        updateDescription();
        if (!notificationSound.src || notificationSound.src === window.location.href) {
             console.warn("æ³¨æ„: é€šçŸ¥éŸ³ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒ <audio> ã‚¿ã‚°ã® src å±æ€§ã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€JavaScriptã§æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`notificationSound.src = '...'` ã®è¡Œã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ãã ã•ã„ã€‚");
        }
    </script>
</body>
</html>
